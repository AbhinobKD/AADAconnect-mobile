<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0b0e17">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AADAconnect</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --c-bg0: #0b0e17; --c-bg1: #111520; --c-bg2: #181d2e; --c-bg3: #1e2438; --c-bg4: #252b42;
      --c-t0: #edf0f9; --c-t1: #8a94b0; --c-t2: #50597a;
      --c-border: rgba(255,255,255,0.07); --c-border2: rgba(255,255,255,0.12);
      --accent: #3b82f6;
      --accent-light: rgba(59,130,246,0.14);
      --accent-mid: rgba(59,130,246,0.35);
      --c-green: #22c55e; --c-green-l: rgba(34,197,94,0.12);
      --c-red: #ef4444;   --c-red-l: rgba(239,68,68,0.12);
      --r2:8px; --r3:12px; --r4:16px; --r5:20px; --r6:24px;
      --font:'Inter',system-ui,sans-serif; --mono:'JetBrains Mono',monospace;
      --card-size: minmax(142px,1fr);
    }

    body.light {
      --c-bg0:#f0f2f7; --c-bg1:#e8eaf2; --c-bg2:#ffffff; --c-bg3:#f5f6fa; --c-bg4:#eceef5;
      --c-t0:#0f1221; --c-t1:#4a5270; --c-t2:#9199b8;
      --c-border:rgba(0,0,0,0.07); --c-border2:rgba(0,0,0,0.12);
      --accent-light:rgba(59,130,246,0.10);
    }

    html,body { height:100%; overflow:hidden; font-family:var(--font); background:var(--c-bg0); color:var(--c-t0); }

    #app { position:fixed; inset:0; display:flex; flex-direction:column; max-width:480px; margin:0 auto; }

    /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
    .hdr { flex-shrink:0; background:var(--c-bg1); border-bottom:1px solid var(--c-border); padding:max(env(safe-area-inset-top),16px) 20px 0; }

    .hdr-top { display:flex; align-items:center; justify-content:space-between; height:52px; }

    .brand { display:flex; align-items:center; gap:11px; }

    .brand-mark { width:36px; height:36px; border-radius:11px; background:var(--accent); display:grid; place-items:center; flex-shrink:0; transition:background .3s; }
    .brand-mark svg { width:19px; height:19px; stroke:#fff; stroke-width:2.2; fill:none; }

    .brand-name { font-size:18px; font-weight:800; letter-spacing:-.6px; line-height:1; color:var(--c-t0); }
    .brand-sub  { font-size:10px; font-weight:500; color:var(--c-t2); letter-spacing:.06em; text-transform:uppercase; margin-top:2px; }

    .hdr-btns { display:flex; gap:8px; }

    .hbtn { width:38px; height:38px; border-radius:var(--r3); background:var(--c-bg3); border:1px solid var(--c-border); display:grid; place-items:center; cursor:pointer; transition:background .15s,border-color .15s,transform .12s; }
    .hbtn:hover  { background:var(--c-bg4); border-color:var(--c-border2); }
    .hbtn:active { transform:scale(0.91); }
    .hbtn svg    { width:17px; height:17px; stroke:var(--c-t1); stroke-width:1.9; fill:none; }

    /* ‚îÄ‚îÄ‚îÄ Summary bar (properly labeled) ‚îÄ‚îÄ‚îÄ */
    .summary-bar { display:flex; gap:6px; padding:12px 0 4px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .summary-bar::-webkit-scrollbar { display:none; }
    .sum-div { display:none; }
    .sstat { display:flex; align-items:center; gap:7px; padding:6px 12px 6px 10px; background:var(--c-bg3); border:1px solid var(--c-border); border-radius:20px; flex-shrink:0; }
    .sstat-dot { width:7px; height:7px; border-radius:50%; background:var(--c-t2); flex-shrink:0; }
    .sstat-num { font-size:13px; font-weight:700; letter-spacing:-.3px; color:var(--c-t0); line-height:1; }
    .sstat-lbl { font-size:12px; font-weight:600; color:var(--c-t2); }
    .sstat.s-online .sstat-dot { background:var(--c-green); }
    .sstat.s-online .sstat-num { color:var(--c-green); }
    .sstat.s-offline .sstat-num { color:var(--c-t1); }

    /* ‚îÄ‚îÄ‚îÄ Conn row ‚îÄ‚îÄ‚îÄ */
    .conn-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0 13px; }

    .conn-badge { display:flex; align-items:center; gap:7px; font-size:12px; font-weight:500; color:var(--c-t2); transition:color .3s; }
    .conn-badge.connected { color:var(--c-t1); }
    .conn-dot { width:7px; height:7px; border-radius:50%; background:var(--c-t2); transition:background .3s; }
    .conn-badge.connected .conn-dot { background:var(--c-green); animation:dpulse 2.4s ease-in-out infinite; }
    @keyframes dpulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    .refresh-time { font-size:11px; font-weight:500; color:var(--c-t2); font-family:var(--mono); }

    /* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
    .search-bar { flex-shrink:0; background:var(--c-bg1); border-bottom:1px solid var(--c-border); overflow:hidden; max-height:0; opacity:0; transition:max-height .3s cubic-bezier(.4,0,.2,1),opacity .25s; }
    .search-bar.open { max-height:106px; opacity:1; }
    .search-inner { padding:12px 20px 0; }
    .srch-wrap { position:relative; }
    .srch-input { width:100%; height:41px; background:var(--c-bg3); border:1px solid var(--c-border); border-radius:var(--r3); color:var(--c-t0); font-family:var(--font); font-size:14px; padding:0 38px 0 38px; outline:none; transition:border-color .2s,box-shadow .2s; }
    .srch-input::placeholder { color:var(--c-t2); }
    .srch-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-light); }
    .srch-ico { position:absolute; left:11px; top:50%; transform:translateY(-50%); width:16px; height:16px; stroke:var(--c-t2); stroke-width:2; fill:none; pointer-events:none; }
    .srch-clear { position:absolute; right:8px; top:50%; transform:translateY(-50%); width:26px; height:26px; border-radius:50%; background:var(--c-bg4); border:1px solid var(--c-border); display:none; place-items:center; cursor:pointer; }
    .srch-clear.show { display:grid; }
    .srch-clear svg { width:12px; height:12px; stroke:var(--c-t1); stroke-width:2.5; fill:none; }

    .filter-row { display:flex; gap:6px; padding:9px 0 12px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .filter-row::-webkit-scrollbar { display:none; }
    .fchip { display:flex; align-items:center; gap:5px; padding:5px 13px; background:var(--c-bg3); border:1px solid var(--c-border); border-radius:20px; font-size:12px; font-weight:600; color:var(--c-t2); cursor:pointer; white-space:nowrap; transition:all .18s; }
    .fchip:active { transform:scale(.95); }
    .fchip.active { background:var(--accent-light); border-color:var(--accent); color:var(--accent); }
    .fchip .dot { width:5px; height:5px; border-radius:50%; background:currentColor; }
    .fchip .cnt { background:rgba(255,255,255,.06); padding:1px 6px; border-radius:8px; font-size:11px; }
    .fchip.active .cnt { background:var(--accent-light); }

    /* ‚ïê‚ïê‚ïê SECTION ROW ‚ïê‚ïê‚ïê */
    .sec-row { display:flex; align-items:center; justify-content:space-between; padding:18px 20px 12px; flex-shrink:0; }
    .sec-title { font-size:19px; font-weight:800; letter-spacing:-.5px; color:var(--c-t0); }
    .sec-actions { display:flex; gap:6px; }
    .sec-btn { display:flex; align-items:center; gap:5px; padding:6px 11px; background:var(--c-bg3); border:1px solid var(--c-border); border-radius:var(--r2); font-family:var(--font); font-size:12px; font-weight:600; color:var(--c-t1); cursor:pointer; transition:all .15s; }
    .sec-btn:hover  { border-color:var(--accent); color:var(--accent); background:var(--accent-light); }
    .sec-btn:active { transform:scale(.95); }
    .sec-btn svg { width:13px; height:13px; stroke:currentColor; stroke-width:2; fill:none; }

    /* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
    .content { flex:1; overflow-y:auto; overscroll-behavior:none; padding:0 16px; }
    .content::-webkit-scrollbar { display:none; }

    /* ‚ïê‚ïê‚ïê DEVICE GRID ‚ïê‚ïê‚ïê */
    .device-grid { display:grid; grid-template-columns:repeat(auto-fill, var(--card-size)); gap:12px; padding-bottom:120px; }
    body.list-mode .device-grid { grid-template-columns:1fr; }

    /* ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ */
    .device-card { background:var(--c-bg2); border:1px solid var(--c-border); border-radius:var(--r5); padding:18px 16px 16px; cursor:pointer; position:relative; overflow:hidden; transition:transform .2s ease,border-color .2s,background .2s; animation:fadeUp .28s ease both; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .device-card:hover  { transform:translateY(-3px); background:var(--c-bg3); border-color:var(--c-border2); }
    .device-card:active { transform:translateY(-1px) scale(.98); }
    .device-card.online { border-color:rgba(59,130,246,.2); }
    .device-card.online::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--accent); border-radius:0 0 1px 1px; }

    /* list mode */
    body.list-mode .device-card { display:flex; align-items:center; gap:14px; padding:14px 16px; }
    body.list-mode .device-card::before { left:0; right:auto; top:0; width:3px; height:100%; border-radius:0 2px 2px 0; }
    body.list-mode .device-icon { margin:0; flex-shrink:0; }
    body.list-mode .device-info { flex:1; text-align:left; min-width:0; }
    body.list-mode .device-name { text-align:left; margin-bottom:2px; }
    body.list-mode .device-rank { text-align:left; }
    body.list-mode .device-status { width:fit-content; }
    body.list-mode .card-footer { margin-top:0; }

    .device-icon { width:48px; height:48px; border-radius:14px; background:var(--c-bg3); border:1px solid var(--c-border); display:grid; place-items:center; margin:0 auto 14px; transition:background .2s,border-color .2s; }
    .device-card.online .device-icon { background:var(--accent-light); border-color:var(--accent-mid); }
    .device-icon svg { width:22px; height:22px; stroke:var(--c-t2); stroke-width:1.8; fill:none; transition:stroke .2s; }
    .device-card.online .device-icon svg { stroke:var(--accent); }

    .device-info { text-align:center; }
    .device-name { font-size:13px; font-weight:700; letter-spacing:-.2px; color:var(--c-t0); margin-bottom:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .device-rank { font-size:10px; font-family:var(--mono); color:var(--c-t2); margin-bottom:10px; }
    .card-footer { margin-top:0; }

    .device-status { display:inline-flex; align-items:center; gap:5px; font-size:11px; font-weight:600; letter-spacing:.03em; padding:4px 10px; border-radius:20px; transition:all .25s; }
    .device-status.online   { background:var(--c-green-l); color:var(--c-green); }
    .device-status.offline  { background:rgba(80,89,122,.15); color:var(--c-t2); }
    .device-status.checking { background:var(--accent-light); color:var(--c-t1); }
    .sdot { width:5px; height:5px; border-radius:50%; background:currentColor; animation:blink 2s ease-in-out infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

    /* loading / empty */
    .loading { grid-column:1/-1; display:flex; flex-direction:column; align-items:center; padding:72px 20px; gap:14px; }
    .spin { width:40px; height:40px; border-radius:50%; border:3px solid var(--c-border); border-top-color:var(--accent); animation:rot .85s linear infinite; }
    @keyframes rot { to{transform:rotate(360deg)} }
    .loading p { font-size:13px; color:var(--c-t2); font-weight:500; }
    .empty { grid-column:1/-1; display:flex; flex-direction:column; align-items:center; padding:60px 20px; text-align:center; }
    .empty-ico { width:68px; height:68px; border-radius:var(--r5); background:var(--c-bg3); border:1px solid var(--c-border); display:grid; place-items:center; margin-bottom:16px; }
    .empty-ico svg { width:32px; height:32px; stroke:var(--c-t2); stroke-width:1.7; fill:none; }
    .empty h3 { font-size:16px; font-weight:700; margin-bottom:6px; }
    .empty p  { font-size:13px; color:var(--c-t2); max-width:250px; line-height:1.6; }

    /* ‚ïê‚ïê‚ïê FAB ‚ïê‚ïê‚ïê */
    .fab { position:fixed; bottom:28px; right:20px; display:flex; align-items:center; gap:9px; padding:0 20px 0 16px; height:52px; background:var(--accent); border:none; border-radius:26px; cursor:pointer; font-family:var(--font); font-size:14px; font-weight:700; color:#fff; z-index:50; transition:transform .18s ease,background .15s; }
    .fab:hover  { transform:translateY(-2px); }
    .fab:active { transform:scale(.96); }
    .fab svg { width:20px; height:20px; stroke:#fff; stroke-width:2.5; fill:none; flex-shrink:0; }

    /* ‚ïê‚ïê‚ïê OVERLAY + SHEETS ‚ïê‚ïê‚ïê */
    .overlay { position:fixed; inset:0; background:rgba(7,10,20,.65); backdrop-filter:blur(12px) saturate(1.4); -webkit-backdrop-filter:blur(12px) saturate(1.4); opacity:0; visibility:hidden; transition:opacity .26s,visibility .26s; z-index:200; }
    .overlay.show { opacity:1; visibility:visible; }
    body.low-end .overlay.show { backdrop-filter:none; background:rgba(7,10,20,.8); }

    .sheet { position:fixed; bottom:0; left:50%; transform:translateX(-50%) translateY(100%); width:100%; max-width:480px; max-height:80vh; background:var(--c-bg1); border-top:1px solid var(--c-border2); border-radius:24px 24px 0 0; padding:0 20px max(env(safe-area-inset-bottom),28px); z-index:201; transition:transform .3s cubic-bezier(.4,0,.2,1); display:flex; flex-direction:column; will-change:transform; box-shadow:0 -12px 60px rgba(0,0,0,.5); }
    .sheet.show { transform:translateX(-50%) translateY(0); }

    .sheet-handle { width:38px; height:4px; background:var(--c-border2); border-radius:2px; margin:14px auto 0; flex-shrink:0; }
    .sheet-hdr { display:flex; align-items:center; justify-content:space-between; padding:16px 4px 14px; flex-shrink:0; }
    .sheet-title { font-size:17px; font-weight:800; letter-spacing:-.4px; }
    .sheet-close { width:30px; height:30px; border-radius:50%; background:var(--c-bg3); border:1px solid var(--c-border); display:grid; place-items:center; cursor:pointer; }
    .sheet-close svg { width:13px; height:13px; stroke:var(--c-t1); stroke-width:2.5; fill:none; }

    .sheet-scroll { overflow-y:auto; flex:1; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
    .sheet-scroll::-webkit-scrollbar { display:none; }

    .sheet-section { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.07em; color:var(--c-t2); padding:16px 4px 8px; }

    /* action rows */
    .arow { display:flex; align-items:center; gap:14px; padding:13px 14px; background:var(--c-bg2); border:1px solid var(--c-border); border-radius:var(--r4); margin-bottom:8px; cursor:pointer; transition:background .15s,border-color .15s,transform .12s; }
    .arow:hover  { background:var(--c-bg3); border-color:var(--c-border2); }
    .arow:active { transform:scale(.98); }
    .arow-ico { width:36px; height:36px; border-radius:10px; background:var(--accent-light); border:1px solid var(--accent-mid); display:grid; place-items:center; flex-shrink:0; }
    .arow-ico svg { width:17px; height:17px; stroke:var(--accent); stroke-width:2.1; fill:none; transition:transform .4s; }
    #themeToggleIcon.rotating svg { transform:rotate(180deg); }
    .arow-body { flex:1; }
    .arow-title { font-size:14px; font-weight:600; color:var(--c-t0); display:flex; align-items:center; gap:6px; }
    .arow-sub   { font-size:12px; color:var(--c-t2); margin-top:1px; }
    .arow.danger .arow-ico { background:var(--c-red-l); border-color:rgba(239,68,68,.3); }
    .arow.danger .arow-ico svg { stroke:var(--c-red); }
    .arow.danger .arow-title { color:var(--c-red); }

    /* toggle */
    .tog { position:relative; width:46px; height:27px; flex-shrink:0; }
    .tog input { opacity:0; width:0; height:0; position:absolute; }
    .tog-track { position:absolute; inset:0; background:var(--c-t2); border-radius:14px; cursor:pointer; transition:background .3s; }
    .tog-track::before { content:''; position:absolute; width:21px; height:21px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:transform .3s; box-shadow:0 1px 4px rgba(0,0,0,.3); }
    .tog input:checked + .tog-track { background:var(--accent); }
    .tog input:checked + .tog-track::before { transform:translateX(19px); }

    .ibadge { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; background:var(--c-bg0); border:1px solid var(--c-border2); color:var(--c-t2); font-size:10px; font-weight:700; font-style:italic; font-family:Georgia,serif; cursor:pointer; user-select:none; flex-shrink:0; }

    .tip { display:none; position:fixed; bottom:108px; left:50%; transform:translateX(-50%); background:var(--c-bg4); border:1px solid var(--c-border2); color:var(--c-t1); font-size:12.5px; font-weight:500; line-height:1.5; padding:11px 16px; border-radius:14px; box-shadow:0 8px 32px rgba(0,0,0,.55); max-width:290px; width:max-content; text-align:center; z-index:9999; pointer-events:none; }

    /* haptics */
    .hap-row { display:flex; align-items:center; padding:13px 14px; background:var(--c-bg2); border:1px solid var(--c-border); border-radius:var(--r4); margin-bottom:8px; }
    .hap-lbl { display:flex; align-items:center; gap:12px; cursor:pointer; flex:1; }
    .hap-lbl input[type="checkbox"] { width:19px; height:19px; accent-color:var(--accent); cursor:pointer; }
    .hap-lbl span { font-size:14px; font-weight:500; color:var(--c-t0); }
    .slider-row { padding:14px 14px; background:var(--c-bg2); border:1px solid var(--c-border); border-radius:var(--r4); margin-bottom:8px; }
    .slider-lbl { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .slider-lbl span:first-child { font-size:14px; font-weight:600; color:var(--c-t0); }
    .slider-lbl span:last-child  { font-size:13px; font-family:var(--mono); color:var(--accent); }
    input[type=range] { width:100%; height:4px; border-radius:2px; background:var(--c-border2); outline:none; -webkit-appearance:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:var(--accent); cursor:pointer; border:3px solid var(--c-bg2); }
    input[type=range]::-moz-range-thumb { width:20px; height:20px; border-radius:50%; background:var(--accent); cursor:pointer; border:3px solid var(--c-bg2); }

    /* sort */
    .sopt { display:flex; align-items:center; justify-content:space-between; padding:13px 14px; background:var(--c-bg2); border:1px solid var(--c-border); border-radius:var(--r4); margin-bottom:8px; cursor:pointer; transition:all .15s; }
    .sopt:active { transform:scale(.98); }
    .sopt.active { background:var(--accent-light); border-color:var(--accent-mid); }
    .sopt-text { font-size:14px; font-weight:600; color:var(--c-t0); }
    .sopt-desc { font-size:12px; color:var(--c-t2); margin-top:2px; }
    .sopt-chk { width:20px; height:20px; border-radius:50%; border:1.5px solid var(--c-border2); display:grid; place-items:center; transition:all .18s; }
    .sopt.active .sopt-chk { background:var(--accent); border-color:var(--accent); }
    .sopt-chk svg { width:11px; height:11px; stroke:#fff; stroke-width:3; fill:none; opacity:0; transition:opacity .18s; }
    .sopt.active .sopt-chk svg { opacity:1; }

    /* accent picker */
    .accent-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:10px; padding:4px 2px 8px; }
    .acc-swatch { aspect-ratio:1; border-radius:50%; cursor:pointer; position:relative; transition:transform .15s; border:2.5px solid transparent; }
    .acc-swatch:hover  { transform:scale(1.1); }
    .acc-swatch:active { transform:scale(.95); }
    .acc-swatch.selected { border-color:var(--c-t0); }
    .acc-swatch.selected::after { content:'‚úì'; position:absolute; inset:0; display:grid; place-items:center; color:#fff; font-size:12px; font-weight:800; }

    /* layout picker */
    .layout-2col { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px; }
    .layout-opt { padding:12px 14px; background:var(--c-bg2); border:1.5px solid var(--c-border); border-radius:var(--r4); cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:8px; transition:all .15s; }
    .layout-opt:active { transform:scale(.97); }
    .layout-opt.active { background:var(--accent-light); border-color:var(--accent); }
    .layout-opt svg { width:28px; height:22px; stroke:var(--c-t2); stroke-width:1.8; fill:none; }
    .layout-opt.active svg { stroke:var(--accent); }
    .layout-opt span { font-size:12px; font-weight:600; color:var(--c-t1); }
    .layout-opt.active span { color:var(--accent); }

    /* quick control swipe */
    .device-card.swipeable { padding:0; overflow:hidden; cursor:default; }
    .device-card.swipeable:hover { transform:none; background:var(--c-bg2); }
    .card-track { display:flex; width:200%; transition:transform .32s cubic-bezier(.4,0,.2,1); will-change:transform; }
    .card-track.revealed { transform:translateX(-50%); }
    .card-panel { width:50%; flex-shrink:0; display:flex; flex-direction:column; align-items:center; }
    .card-panel-info { padding:18px 16px 16px; position:relative; width:50%; }
    .card-panel-info .device-name { width:100%; }
    .card-panel-control { justify-content:center; gap:10px; padding:18px 14px; }
    .swipe-hint { position:absolute; right:8px; top:46px; transform:translateY(-50%); pointer-events:none; opacity:0; animation:hintFade .5s ease 1.2s forwards,hintBounce 2s ease-in-out 1.7s infinite; }
    .swipe-hint svg { width:11px; height:11px; stroke:var(--c-t2); stroke-width:2.5; fill:none; }
    .card-track.revealed .swipe-hint { display:none; }
    @keyframes hintFade   { to{opacity:.5} }
    @keyframes hintBounce { 0%,100%{transform:translateY(-50%) translateX(0)} 50%{transform:translateY(-50%) translateX(-4px)} }
    .qc-back-hint { position:absolute; left:8px; top:50%; transform:translateY(-50%); pointer-events:none; opacity:.3; }
    .qc-back-hint svg { width:11px; height:11px; stroke:var(--c-t2); stroke-width:2.5; fill:none; }

    .qc-btn { width:56px; height:56px; border-radius:50%; border:none; cursor:pointer; display:grid; place-items:center; transition:transform .16s,opacity .2s; }
    .qc-btn:active { transform:scale(.9); }
    .qc-btn.state-on      { background:var(--c-green); }
    .qc-btn.state-off     { background:var(--accent); }
    .qc-btn.state-pending { background:var(--accent); opacity:.7; cursor:default; animation:pendP .9s ease-in-out infinite; }
    .qc-btn.state-unknown { background:var(--c-bg3); border:1.5px solid var(--c-border2); }
    @keyframes pendP { 0%,100%{opacity:.7} 50%{opacity:1} }
    .qc-btn svg { width:22px; height:22px; stroke:#fff; stroke-width:2.2; stroke-linecap:round; fill:none; }
    .qc-btn.state-unknown svg { stroke:var(--c-t2); }
    .qc-btn.state-pending svg { opacity:.75; }
    .qc-lbl { font-size:9px; font-family:var(--mono); font-weight:500; letter-spacing:.1em; text-transform:uppercase; text-align:center; }
    .qc-lbl.state-on      { color:var(--c-green); }
    .qc-lbl.state-off     { color:var(--accent); }
    .qc-lbl.state-pending { color:var(--c-t2); }
    .qc-lbl.state-unknown { color:var(--c-t2); }

    .blur-layer { display:none; }

    @media (max-width:360px) { :root { --card-size:minmax(130px,1fr); } }
  </style>
</head>
<body>

<div id="app">
  <header class="hdr">
    <div class="hdr-top">
      <div class="brand">
        <div class="brand-mark">
          <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        </div>
        <div>
          <div class="brand-name">AADAconnect</div>
          <div class="brand-sub">IoT Controller</div>
        </div>
      </div>
      <div class="hdr-btns">
        <div class="hbtn" id="searchToggleBtn"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
        <div class="hbtn" id="moreOptionsBtn"><svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="1.2" fill="currentColor" stroke="none"/><circle cx="12" cy="12" r="1.2" fill="currentColor" stroke="none"/><circle cx="12" cy="19" r="1.2" fill="currentColor" stroke="none"/></svg></div>
      </div>
    </div>
    <div class="summary-bar">
      <div class="sstat">
        <span class="sstat-dot"></span>
        <span class="sstat-num" id="totalCount">‚Äî</span>
        <span class="sstat-lbl">Total</span>
      </div>
      <div class="sstat s-online">
        <span class="sstat-dot"></span>
        <span class="sstat-num" id="onlineCount">‚Äî</span>
        <span class="sstat-lbl">Online</span>
      </div>
      <div class="sstat s-offline">
        <span class="sstat-dot"></span>
        <span class="sstat-num" id="offlineCount">‚Äî</span>
        <span class="sstat-lbl">Offline</span>
      </div>
    </div>

    <div class="conn-row">
      <div class="conn-badge" id="connBadge">
        <span class="conn-dot" id="mqttStatus"></span>
        <span id="userEmail">Connecting‚Ä¶</span>
      </div>
      <div class="refresh-time" id="lastRefreshTime">‚Äî</div>
    </div>
  </header>

  <div class="search-bar" id="searchContainer">
    <div class="search-inner">
      <div class="srch-wrap">
        <svg class="srch-ico" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" class="srch-input" id="searchInput" placeholder="Search devices‚Ä¶" autocomplete="off" spellcheck="false">
        <div class="srch-clear" id="clearSearch"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
      </div>
      <div class="filter-row">
        <div class="fchip active" data-filter="all">All <span class="cnt" id="totalDevices">0</span></div>
        <div class="fchip" data-filter="online"><span class="dot"></span>Online <span class="cnt" id="onlineDevices">0</span></div>
        <div class="fchip" data-filter="offline"><span class="dot"></span>Offline <span class="cnt" id="offlineDevices">0</span></div>
      </div>
    </div>
  </div>

  <div class="sec-row">
    <div class="sec-title">My Devices</div>
    <div class="sec-actions">
      <button class="sec-btn" id="sortBtn">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
        <span id="sortLabel">Rank</span>
      </button>
    </div>
  </div>

  <div class="content">
    <div class="device-grid" id="deviceGrid">
      <div class="loading"><div class="spin"></div><p>Loading devices‚Ä¶</p></div>
    </div>
  </div>

  <button class="fab" id="addDeviceBtn">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Add Device
  </button>
</div>

<div class="overlay" id="actionSheetOverlay"></div>

<!-- Options Sheet -->
<div class="sheet" id="actionSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-hdr">
    <div class="sheet-title">Options</div>
    <div class="sheet-close" onclick="closeAllSheets()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
  </div>
  <div class="sheet-scroll">
    <div class="sheet-section">Device Management</div>
    <div class="arow" id="refreshItem">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></div>
      <div class="arow-body"><div class="arow-title">Refresh Devices</div><div class="arow-sub">Ping all devices for status</div></div>
    </div>

    <div class="sheet-section">Appearance</div>
    <div class="arow" id="themeToggleItem">
      <div class="arow-ico" id="themeToggleIcon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
      <div class="arow-body"><div class="arow-title">Toggle Theme</div><div class="arow-sub" id="themeLabel">Currently Dark</div></div>
    </div>
    <div class="arow" id="accentPickerItem">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 3v9m0 0 4.5 4.5M12 12l-4.5 4.5"/></svg></div>
      <div class="arow-body"><div class="arow-title">Accent Color</div><div class="arow-sub">Personalise your interface</div></div>
      <div id="accentPreview" style="width:20px;height:20px;border-radius:50%;background:var(--accent);flex-shrink:0;border:2px solid var(--c-border2);"></div>
    </div>
    <div class="arow" id="layoutPickerItem">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
      <div class="arow-body"><div class="arow-title">Card Layout</div><div class="arow-sub">Grid or list view + density</div></div>
    </div>

    <div class="sheet-section">Controls</div>
    <div class="arow" id="hapticsItem">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg></div>
      <div class="arow-body"><div class="arow-title">Haptic Feedback</div><div class="arow-sub">Configure vibration settings</div></div>
    </div>
    <div class="arow" id="quickControlItem" style="cursor:default;">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg></div>
      <div class="arow-body">
        <div class="arow-title">Quick Control <span class="ibadge" id="qcInfoBtn">i</span></div>
        <div class="arow-sub">Swipe card left to toggle power</div>
      </div>
      <label class="tog" onclick="event.stopPropagation()"><input type="checkbox" id="quickControlToggle" onchange="toggleQuickControl(this.checked)"><span class="tog-track"></span></label>
    </div>
    <div id="qcTooltip" class="tip">üí° Swipe a device card <strong>left</strong> to reveal quick power controls</div>

    <div class="sheet-section">Account</div>
    <div class="arow" id="rememberMeItem" style="cursor:default;">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <div class="arow-body">
        <div class="arow-title">Remember Me <span class="ibadge" id="rmInfoBtn">i</span></div>
        <div class="arow-sub">Stay logged in between sessions</div>
      </div>
      <label class="tog" onclick="event.stopPropagation()"><input type="checkbox" id="rememberMeToggle" onchange="toggleRememberMe(this.checked)"><span class="tog-track"></span></label>
    </div>
    <div id="rmTooltip" class="tip">üîê Skip login and jump straight to dashboard next visit</div>
    <div class="arow danger" id="logoutItem">
      <div class="arow-ico"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
      <div class="arow-body"><div class="arow-title">Sign Out</div><div class="arow-sub">Log out of your account</div></div>
    </div>
  </div>
</div>

<!-- Haptics Sheet -->
<div class="sheet" id="hapticsSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-hdr">
    <div class="sheet-title">Haptic Feedback</div>
    <div class="sheet-close" onclick="closeAllSheets()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
  </div>
  <div class="sheet-scroll">
    <div class="sheet-section">Triggers</div>
    <div class="hap-row"><label class="hap-lbl"><input type="checkbox" id="hapticsController"><span>Controller on/off button</span></label></div>
    <div class="hap-row"><label class="hap-lbl"><input type="checkbox" id="hapticsAll"><span>All interactive elements</span></label></div>
    <div class="sheet-section">Intensity</div>
    <div class="slider-row">
      <div class="slider-lbl"><span>Vibration Duration</span><span id="intensityValue">50ms</span></div>
      <input type="range" id="hapticsIntensity" min="10" max="200" step="10" value="50">
    </div>
  </div>
</div>

<!-- Sort Sheet -->
<div class="sheet" id="sortSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-hdr">
    <div class="sheet-title">Sort Devices</div>
    <div class="sheet-close" onclick="closeAllSheets()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
  </div>
  <div class="sheet-scroll">
    <div class="sopt active" data-sort="rank"><div><div class="sopt-text">By Rank</div><div class="sopt-desc">Device rank number</div></div><div class="sopt-chk"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div></div>
    <div class="sopt" data-sort="name"><div><div class="sopt-text">By Name</div><div class="sopt-desc">Alphabetical A ‚Üí Z</div></div><div class="sopt-chk"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div></div>
    <div class="sopt" data-sort="status"><div><div class="sopt-text">By Status</div><div class="sopt-desc">Online devices first</div></div><div class="sopt-chk"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div></div>
    <div class="sopt" data-sort="recent"><div><div class="sopt-text">Recently Added</div><div class="sopt-desc">Newest first</div></div><div class="sopt-chk"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div></div>
  </div>
</div>

<!-- Accent Sheet -->
<div class="sheet" id="accentSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-hdr">
    <div class="sheet-title">Accent Color</div>
    <div class="sheet-close" onclick="closeAllSheets()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
  </div>
  <div class="sheet-scroll">
    <div class="sheet-section">Presets</div>
    <div class="accent-grid" id="accentGrid"></div>
    <div class="sheet-section">Custom</div>
    <div style="display:flex;gap:12px;align-items:center;padding:4px 2px 16px;">
      <input type="color" id="customAccentInput" style="width:46px;height:46px;border:none;background:none;cursor:pointer;border-radius:10px;padding:2px;" value="#3b82f6">
      <div><div style="font-size:14px;font-weight:600;color:var(--c-t0);">Custom color</div><div style="font-size:12px;color:var(--c-t2);margin-top:2px;">Pick any color from the system palette</div></div>
    </div>
  </div>
</div>

<!-- Layout Sheet -->
<div class="sheet" id="layoutSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-hdr">
    <div class="sheet-title">Card Layout</div>
    <div class="sheet-close" onclick="closeAllSheets()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
  </div>
  <div class="sheet-scroll">
    <div class="sheet-section">View Mode</div>
    <div class="layout-2col">
      <div class="layout-opt active" data-layout="grid" id="layoutOptGrid"><svg viewBox="0 0 28 22"><rect x="1" y="1" width="11" height="9" rx="2"/><rect x="16" y="1" width="11" height="9" rx="2"/><rect x="1" y="13" width="11" height="9" rx="2"/><rect x="16" y="13" width="11" height="9" rx="2"/></svg><span>Grid</span></div>
      <div class="layout-opt" data-layout="list" id="layoutOptList"><svg viewBox="0 0 28 22"><rect x="1" y="1" width="26" height="6" rx="2"/><rect x="1" y="10" width="26" height="6" rx="2"/><rect x="1" y="19" width="26" height="3" rx="1.5"/></svg><span>List</span></div>
    </div>
    <div class="sheet-section">Grid Density</div>
    <div class="layout-2col">
      <div class="layout-opt active" data-density="comfortable" id="densityComf"><svg viewBox="0 0 28 22"><rect x="1" y="1" width="11" height="20" rx="2"/><rect x="16" y="1" width="11" height="20" rx="2"/></svg><span>Comfortable</span></div>
      <div class="layout-opt" data-density="compact" id="densityComp"><svg viewBox="0 0 28 22"><rect x="1" y="1" width="7" height="9" rx="1.5"/><rect x="11" y="1" width="7" height="9" rx="1.5"/><rect x="21" y="1" width="6" height="9" rx="1.5"/><rect x="1" y="13" width="7" height="9" rx="1.5"/><rect x="11" y="13" width="7" height="9" rx="1.5"/><rect x="21" y="13" width="6" height="9" rx="1.5"/></svg><span>Compact</span></div>
    </div>
  </div>
</div>

<script>
  if (navigator.hardwareConcurrency <= 4) document.body.classList.add('low-end');

  /* ‚îÄ‚îÄ Accent colors ‚îÄ‚îÄ */
  const ACCENTS = [
    '#3b82f6','#8b5cf6','#ec4899','#f97316',
    '#22c55e','#06b6d4','#a855f7','#f59e0b',
    '#ef4444','#14b8a6','#64748b','#84cc16'
  ];

  function hexToRgb(h) { return [parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)].join(','); }

  function applyAccent(hex) {
    const r = document.documentElement;
    r.style.setProperty('--accent', hex);
    r.style.setProperty('--accent-light', `rgba(${hexToRgb(hex)},0.14)`);
    r.style.setProperty('--accent-mid',   `rgba(${hexToRgb(hex)},0.35)`);
    localStorage.setItem('accentColor', hex);
    const prev = document.getElementById('accentPreview');
    if (prev) prev.style.background = hex;
    document.querySelectorAll('.acc-swatch').forEach(s => s.classList.toggle('selected', s.dataset.hex === hex));
    const ci = document.getElementById('customAccentInput');
    if (ci) ci.value = hex;
    const bm = document.querySelector('.brand-mark');
    if (bm) bm.style.background = hex;
    const fab = document.querySelector('.fab');
    if (fab) fab.style.background = hex;
  }

  function buildAccentGrid() {
    const grid  = document.getElementById('accentGrid');
    const saved = localStorage.getItem('accentColor') || '#3b82f6';
    ACCENTS.forEach(hex => {
      const s = document.createElement('div');
      s.className = 'acc-swatch' + (hex === saved ? ' selected' : '');
      s.style.background = hex;
      s.dataset.hex = hex;
      s.addEventListener('click', () => applyAccent(hex));
      grid.appendChild(s);
    });
    document.getElementById('customAccentInput').addEventListener('input', e => {
      applyAccent(e.target.value);
      document.querySelectorAll('.acc-swatch').forEach(s => s.classList.remove('selected'));
    });
    applyAccent(saved);
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  let currentLayout  = localStorage.getItem('layout')  || 'grid';
  let currentDensity = localStorage.getItem('density') || 'comfortable';
  const DENSITY_MAP  = { comfortable:'minmax(142px,1fr)', compact:'minmax(110px,1fr)' };

  function applyLayout() {
    document.body.classList.toggle('list-mode', currentLayout === 'list');
    if (currentLayout === 'grid') document.documentElement.style.setProperty('--card-size', DENSITY_MAP[currentDensity]);
    ['layoutOptGrid','layoutOptList'].forEach(id => { const el=document.getElementById(id); if(el) el.classList.toggle('active', el.dataset.layout === currentLayout); });
    ['densityComf','densityComp'].forEach(id => { const el=document.getElementById(id); if(el) el.classList.toggle('active', el.dataset.density === currentDensity); });
  }

  document.getElementById('layoutOptGrid').addEventListener('click', () => { currentLayout='grid'; localStorage.setItem('layout','grid'); applyLayout(); renderDevices(); });
  document.getElementById('layoutOptList').addEventListener('click', () => { currentLayout='list'; localStorage.setItem('layout','list'); applyLayout(); renderDevices(); });
  document.getElementById('densityComf').addEventListener('click', () => { currentDensity='comfortable'; localStorage.setItem('density','comfortable'); applyLayout(); renderDevices(); });
  document.getElementById('densityComp').addEventListener('click', () => { currentDensity='compact'; localStorage.setItem('density','compact'); applyLayout(); renderDevices(); });

  /* ‚îÄ‚îÄ Haptics ‚îÄ‚îÄ */
  function hapticFeedback(ms) { if ('vibrate' in navigator && ms > 0) navigator.vibrate(ms); }
  function getHapticIntensity() { return parseInt(localStorage.getItem('hapticsIntensity') || '50'); }
  function shouldHapticAll()        { return localStorage.getItem('hapticsAll') === 'true'; }
  function shouldHapticController() { return localStorage.getItem('hapticsController') === 'true'; }
  function addHapticToElement(el, cb) { el.addEventListener('click', e => { if(shouldHapticAll()) hapticFeedback(getHapticIntensity()); if(cb) cb(e); }); }

  /* ‚îÄ‚îÄ Globals ‚îÄ‚îÄ */
  let mqttClient = null, devices = [], currentUser = null;
  let deviceOnlineStatus = {}, deviceTimeouts = {}, deviceListTimeout = null, renderTimeout = null;
  let currentSortBy = localStorage.getItem('sortBy') || 'rank';
  let currentFilter = 'all', searchQuery = '';
  let devicePowerStatus = {}, deviceSwipeState = {};

  /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
  function init() {
    currentUser = JSON.parse(sessionStorage.getItem('current_user') || 'null');
    if (!currentUser) {
      const rem = localStorage.getItem('remembered_user');
      if (rem) { try { currentUser=JSON.parse(rem); sessionStorage.setItem('current_user',rem); } catch(e){} }
    }
    if (!currentUser) { window.location.href='login.html'; return; }
    document.getElementById('userEmail').textContent = currentUser.email;
    loadTheme(); buildAccentGrid(); applyLayout();
    setupEventListeners(); connectMQTT(); loadHapticsSettings();
    currentSortBy = localStorage.getItem('sortBy') || 'rank'; updateSortLabel(); syncSortSheet();
    document.getElementById('quickControlToggle').checked = localStorage.getItem('quickControl') === 'true';
    document.getElementById('rememberMeToggle').checked   = localStorage.getItem('rememberMe')   === 'true';
  }

  function loadTheme() { document.body.classList.toggle('light', localStorage.getItem('theme')==='light'); updateThemeLabel(); }

  function toggleTheme() {
    const icon = document.getElementById('themeToggleIcon');
    icon.classList.add('rotating');
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    updateThemeLabel();
    setTimeout(() => { icon.classList.remove('rotating'); hideActionSheet(); }, 420);
  }

  function updateThemeLabel() {
    const lbl = document.getElementById('themeLabel');
    if (lbl) lbl.textContent = document.body.classList.contains('light') ? 'Currently Light' : 'Currently Dark';
  }

  function setupEventListeners() {
    addHapticToElement(document.getElementById('moreOptionsBtn'), showActionSheet);
    addHapticToElement(document.getElementById('addDeviceBtn'), addDevice);
    addHapticToElement(document.getElementById('searchToggleBtn'), toggleSearch);
    addHapticToElement(document.getElementById('sortBtn'), showSortSheet);
    document.getElementById('actionSheetOverlay').addEventListener('click', closeAllSheets);
    addHapticToElement(document.getElementById('refreshItem'), refreshDevices);
    addHapticToElement(document.getElementById('themeToggleItem'), toggleTheme);
    addHapticToElement(document.getElementById('hapticsItem'), showHapticsSheet);
    addHapticToElement(document.getElementById('logoutItem'), logout);
    addHapticToElement(document.getElementById('accentPickerItem'), showAccentSheet);
    addHapticToElement(document.getElementById('layoutPickerItem'), showLayoutSheet);

    document.getElementById('hapticsIntensity').addEventListener('input', function() { updateIntensityDisplay(); saveHapticsSettings(); hapticFeedback(parseInt(this.value)); });
    document.getElementById('hapticsController').addEventListener('change', saveHapticsSettings);
    document.getElementById('hapticsAll').addEventListener('change', saveHapticsSettings);

    const si = document.getElementById('searchInput');
    si.addEventListener('input', e => { searchQuery=e.target.value.toLowerCase(); document.getElementById('clearSearch').classList.toggle('show',searchQuery.length>0); renderDevices(); });
    document.getElementById('clearSearch').addEventListener('click', () => { si.value=''; searchQuery=''; document.getElementById('clearSearch').classList.remove('show'); renderDevices(); });

    document.querySelectorAll('.fchip').forEach(c => { c.addEventListener('click', () => { document.querySelectorAll('.fchip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); currentFilter=c.dataset.filter; renderDevices(); }); });

    document.querySelectorAll('.sopt').forEach(opt => {
      addHapticToElement(opt, () => { currentSortBy=opt.dataset.sort; localStorage.setItem('sortBy',currentSortBy); syncSortSheet(); updateSortLabel(); renderDevices(); setTimeout(closeAllSheets,280); });
    });
  }

  function toggleSearch() {
    const bar = document.getElementById('searchContainer');
    if (bar.classList.toggle('open')) setTimeout(() => document.getElementById('searchInput').focus(), 250);
    else { document.getElementById('searchInput').value=''; searchQuery=''; renderDevices(); }
  }

  const ALL_SHEETS = ['actionSheet','hapticsSheet','sortSheet','accentSheet','layoutSheet'];
  function openSheet(id) { document.getElementById('actionSheetOverlay').classList.add('show'); document.getElementById(id).classList.add('show'); }
  function closeAllSheets() { document.getElementById('actionSheetOverlay').classList.remove('show'); ALL_SHEETS.forEach(id => document.getElementById(id).classList.remove('show')); }
  function showBlurLayer(){}; function hideBlurLayer(){};
  function showActionSheet() { openSheet('actionSheet'); }
  function hideActionSheet() { closeAllSheets(); }
  function showHapticsSheet() { closeAllSheets(); loadHapticsSettings(); updateIntensityDisplay(); openSheet('hapticsSheet'); }
  function hideHapticsSheet() { closeAllSheets(); }
  function showSortSheet()    { syncSortSheet(); openSheet('sortSheet'); }
  function hideSortSheet()    { closeAllSheets(); }
  function showAccentSheet()  { closeAllSheets(); openSheet('accentSheet'); }
  function showLayoutSheet()  { closeAllSheets(); openSheet('layoutSheet'); }

  function syncSortSheet() { document.querySelectorAll('.sopt').forEach(o => o.classList.toggle('active', o.dataset.sort===currentSortBy)); }
  function updateSortLabel() { const m={rank:'Rank',name:'Name',status:'Status',recent:'Recent'}; document.getElementById('sortLabel').textContent=m[currentSortBy]||'Rank'; }

  function loadHapticsSettings() {
    document.getElementById('hapticsController').checked = localStorage.getItem('hapticsController')==='true';
    document.getElementById('hapticsAll').checked        = localStorage.getItem('hapticsAll')==='true';
    document.getElementById('hapticsIntensity').value    = getHapticIntensity();
    updateIntensityDisplay();
  }
  function updateIntensityDisplay() { document.getElementById('intensityValue').textContent = document.getElementById('hapticsIntensity').value+'ms'; }
  function saveHapticsSettings() { localStorage.setItem('hapticsController',document.getElementById('hapticsController').checked); localStorage.setItem('hapticsAll',document.getElementById('hapticsAll').checked); localStorage.setItem('hapticsIntensity',document.getElementById('hapticsIntensity').value); }

  function connectMQTT() {
    const badge = document.getElementById('connBadge');
    try {
      mqttClient = mqtt.connect('wss://y1dda1f8.ala.asia-southeast1.emqxsl.com:8084/mqtt', { username:'AADAconnect', password:'wMhtXcU86UtV-48' });
      mqttClient.on('connect', () => { badge.classList.add('connected'); mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/fetch`, err => { if(!err) deviceListTimeout=setTimeout(()=>{ if(devices.length===0) renderDevices(); },5000); }); });
      mqttClient.on('message', handleMQTTMessage);
      mqttClient.on('error', () => { badge.classList.remove('connected'); if(devices.length===0) renderDevices(); });
      mqttClient.on('close', () => { badge.classList.remove('connected'); if(devices.length===0) renderDevices(); });
    } catch(e) { badge.classList.remove('connected'); renderDevices(); }
  }

  function handleMQTTMessage(topic, message) {
    const parts = topic.split('/');
    try {
      const data = JSON.parse(message.toString());
      if (data.device_list && Array.isArray(data.device_list)) {
        clearTimeout(deviceListTimeout); devices=data.device_list; renderDevices();
        devices.forEach(d => { mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/status`); mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/OF`); });
        checkAllDevicesStatus();
      }
    } catch(e) {}

    if (parts[parts.length-1]==='OF') {
      const did=parts[parts.length-2], raw=message.toString().trim(), low=raw.toLowerCase();
      if(low==='check_status') return;
      clearTimeout(deviceTimeouts[did]); delete deviceTimeouts[did];
      deviceOnlineStatus[did] = low==='offline' ? 'offline' : raw;
      updateDeviceOnlineStatus(did, deviceOnlineStatus[did], low!=='offline');
    }
    if (parts[parts.length-1]==='status') {
      const did=parts[parts.length-2], status=message.toString().trim().toUpperCase();
      if(status==='ON'||status==='OFF') { devicePowerStatus[did]=status; document.querySelectorAll(`.device-card[data-device-id="${did}"]`).forEach(card=>updateQcPanel(card,did,deviceOnlineStatus[did]!=='offline'&&deviceOnlineStatus[did]!=='Checking...')); }
    }
  }

  function updateStats() {
    const total=devices.length, online=devices.filter(d=>{const s=deviceOnlineStatus[d.device_id];return s&&s!=='offline'&&s!=='Checking...';}).length, offline=total-online;
    document.getElementById('totalCount').textContent   = total;
    document.getElementById('onlineCount').textContent  = online;
    document.getElementById('offlineCount').textContent = offline;
    document.getElementById('totalDevices').textContent   = total;
    document.getElementById('onlineDevices').textContent  = online;
    document.getElementById('offlineDevices').textContent = offline;
    const now=new Date(), h=String(now.getHours()).padStart(2,'0'), m=String(now.getMinutes()).padStart(2,'0');
    document.getElementById('lastRefreshTime').textContent = `Updated ${h}:${m}`;
  }

  function sortDevices(list) {
    const s=[...list];
    if(currentSortBy==='name') return s.sort((a,b)=>a.device_id.localeCompare(b.device_id));
    if(currentSortBy==='status') { const on=s.filter(d=>deviceOnlineStatus[d.device_id]!=='offline'&&deviceOnlineStatus[d.device_id]!=='Checking...'),off=s.filter(d=>deviceOnlineStatus[d.device_id]==='offline'||deviceOnlineStatus[d.device_id]==='Checking...'); return [...on,...off]; }
    if(currentSortBy==='recent') return s.reverse();
    return s.sort((a,b)=>a.device_rank-b.device_rank);
  }

  function filterDevices(list) {
    let f=list;
    if(searchQuery) f=f.filter(d=>d.device_id.toLowerCase().includes(searchQuery));
    if(currentFilter==='online')  f=f.filter(d=>deviceOnlineStatus[d.device_id]!=='offline'&&deviceOnlineStatus[d.device_id]!=='Checking...');
    if(currentFilter==='offline') f=f.filter(d=>deviceOnlineStatus[d.device_id]==='offline'||deviceOnlineStatus[d.device_id]==='Checking...');
    return f;
  }

  const ICON_SVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M12 16h.01"/></svg>`;

  function renderDevices() {
    if (renderTimeout) clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => {
      const grid = document.getElementById('deviceGrid');
      updateStats();
      if (devices.length === 0) { grid.innerHTML=`<div class="empty"><div class="empty-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 12h6M12 9v6"/></svg></div><h3>No Devices Yet</h3><p>Tap Add Device to connect your first smart device.</p></div>`; return; }
      const display = sortDevices(filterDevices(devices));
      if (display.length === 0) { grid.innerHTML=`<div class="empty"><div class="empty-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div><h3>No Results</h3><p>Try adjusting your search or filter.</p></div>`; return; }

      grid.innerHTML='';
      const qc = localStorage.getItem('quickControl')==='true';
      const isList = document.body.classList.contains('list-mode');

      display.forEach((device, idx) => {
        const msg = deviceOnlineStatus[device.device_id] || 'offline';
        const isOnline = !(msg==='offline'||msg==='Checking...');
        const card = document.createElement('div');
        card.className = `device-card${isOnline?' online':''}`;
        card.dataset.deviceId = device.device_id;
        card.style.animationDelay = (idx*35)+'ms';

        if (qc && isOnline) {
          card.classList.add('swipeable');
          if (deviceSwipeState[device.device_id]) card.classList.add('swiped');
          const ks=devicePowerStatus[device.device_id]||null;
          const bs=ks==='ON'?'state-on':ks==='OFF'?'state-off':'state-unknown';
          const lt=ks==='ON'?'ON':ks==='OFF'?'OFF':'‚Äî';
          const tc=deviceSwipeState[device.device_id]?'card-track revealed':'card-track';
          card.innerHTML=`<div class="${tc}">
            <div class="card-panel card-panel-info">
              <div class="device-icon">${ICON_SVG}</div>
              <div class="device-info">
                <div class="device-name" style="width:100%">${device.device_id}</div>
                <div class="device-rank">#${device.device_rank}</div>
                <div class="card-footer"><div class="device-status online"><span class="sdot"></span>${msg}</div></div>
              </div>
              <div class="swipe-hint"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></div>
            </div>
            <div class="card-panel card-panel-control" style="position:relative;">
              <div class="qc-back-hint"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg></div>
              <button class="qc-btn ${bs}" data-device-id="${device.device_id}" onclick="event.stopPropagation();quickToggleDevice('${device.device_id}',this)">
                <svg viewBox="0 0 24 24"><path d="M12 2v10"/><path d="M18.4 6.6a9 9 0 1 1-12.77.04"/></svg>
              </button>
              <span class="qc-lbl ${bs}">${lt}</span>
            </div>
          </div>`;
          attachSwipeListeners(card, device.device_id);
        } else {
          const sc = msg==='Checking...'?'checking':(isOnline?'online':'offline');
          if (isList) {
            card.innerHTML=`<div class="device-icon">${ICON_SVG}</div><div class="device-info"><div class="device-name">${device.device_id}</div><div class="device-rank">#${device.device_rank}</div></div><div class="card-footer"><div class="device-status ${sc}"><span class="sdot"></span>${msg}</div></div>`;
          } else {
            card.innerHTML=`<div class="device-icon">${ICON_SVG}</div><div class="device-info"><div class="device-name">${device.device_id}</div><div class="device-rank">#${device.device_rank}</div><div class="card-footer"><div class="device-status ${sc}"><span class="sdot"></span>${msg}</div></div></div>`;
          }
          addHapticToElement(card, () => openDeviceControl(device.device_id));
        }
        grid.appendChild(card);
      });
      updateStats();
    }, 80);
  }

  function updateDeviceOnlineStatus(deviceId, message, isOnline) {
    document.querySelectorAll(`.device-card[data-device-id="${deviceId}"]`).forEach(card => {
      card.classList.toggle('online', isOnline);
      const statusEl = card.querySelector('.device-status');
      if (statusEl) { statusEl.className=`device-status ${message==='Checking...'?'checking':(isOnline?'online':'offline')}`; statusEl.innerHTML=`<span class="sdot"></span>${message}`; }
      updateQcPanel(card, deviceId, isOnline);
    });
    debouncedUpdateStats();
    if (currentSortBy==='status') debouncedRenderDevices();
  }

  let _st=null, _rt=null;
  function debouncedUpdateStats()   { clearTimeout(_st); _st=setTimeout(updateStats,150); }
  function debouncedRenderDevices() { clearTimeout(_rt); _rt=setTimeout(renderDevices,300); }

  function checkAllDevicesStatus() {
    devices.forEach(d => {
      deviceOnlineStatus[d.device_id]='Checking...';
      updateDeviceOnlineStatus(d.device_id,'Checking...',false);
      clearTimeout(deviceTimeouts[d.device_id]);
      mqttClient.publish(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/OF`,'check_status');
      deviceTimeouts[d.device_id]=setTimeout(()=>{ if(deviceOnlineStatus[d.device_id]==='Checking...'){ deviceOnlineStatus[d.device_id]='offline'; updateDeviceOnlineStatus(d.device_id,'offline',false); } },5000);
    });
    updateStats();
  }

  function openDeviceControl(deviceId) {
    sessionStorage.setItem('active_device',deviceId);
    sessionStorage.setItem('device_status_cache',JSON.stringify({ status:deviceOnlineStatus[deviceId]||'unknown', isOnline:deviceOnlineStatus[deviceId]!=='offline'&&deviceOnlineStatus[deviceId]!=='Checking...'&&deviceOnlineStatus[deviceId]!=='unknown', timestamp:Date.now() }));
    window.location.href='control.html';
  }

  function addDevice() {
    hideActionSheet();
    const deviceId='AADA-'+Math.random().toString(36).substr(2,8).toUpperCase();
    sessionStorage.setItem('provisioning',JSON.stringify({ email:currentUser.email, password:currentUser.password, hashed_email:currentUser.hashed_email, hashed_password:currentUser.hashed_password, device_id:deviceId }));
    window.location.href='wifi_setup.html';
  }

  function refreshDevices() {
    hideActionSheet();
    if (!mqttClient?.connected) { alert('Not connected to server'); return; }
    checkAllDevicesStatus();
    const grid=document.getElementById('deviceGrid');
    grid.style.opacity='.5'; grid.style.transition='opacity .2s';
    setTimeout(()=>{ grid.style.opacity='1'; },380);
  }

  function logout() {
    hideActionSheet();
    if (confirm('Sign out of AADAconnect?')) { localStorage.removeItem('remembered_user'); localStorage.removeItem('rememberMe'); sessionStorage.clear(); window.location.href='login.html'; }
  }

  function toggleRememberMe(enabled) {
    localStorage.setItem('rememberMe',enabled?'true':'false');
    if(enabled&&currentUser) localStorage.setItem('remembered_user',JSON.stringify(currentUser));
    else localStorage.removeItem('remembered_user');
  }

  function toggleQuickControl(enabled) {
    localStorage.setItem('quickControl',enabled?'true':'false');
    if(enabled&&mqttClient?.connected) devices.forEach(d=>mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/status`));
    deviceSwipeState={}; renderDevices();
  }

  function attachSwipeListeners(card, deviceId) {
    let sX=0,sY=0,sT=0,drag=false,scroll=false;
    card.addEventListener('touchstart',e=>{sX=e.touches[0].clientX;sY=e.touches[0].clientY;sT=Date.now();drag=true;scroll=false;},{passive:true});
    card.addEventListener('touchmove', e=>{if(!drag)return;const a=Math.abs(Math.atan2(e.touches[0].clientY-sY,e.touches[0].clientX-sX)*180/Math.PI);if(a>35&&a<145)scroll=true;},{passive:true});
    card.addEventListener('touchend',  e=>{
      if(!drag||scroll){drag=false;return;}drag=false;
      const dx=e.changedTouches[0].clientX-sX,dt=Date.now()-sT,isSwipe=Math.abs(dx)>36||(Math.abs(dx)>18&&dt<250);
      const track=card.querySelector('.card-track');
      if(!isSwipe){if(!track||!track.classList.contains('revealed'))openDeviceControl(deviceId);return;}
      if(!track)return;const rev=track.classList.contains('revealed');
      if(dx<0&&!rev){track.classList.add('revealed');card.classList.add('swiped');deviceSwipeState[deviceId]=true;}
      else if(dx>0&&rev){track.classList.remove('revealed');card.classList.remove('swiped');deviceSwipeState[deviceId]=false;}
      else if(dx>0&&!rev){openDeviceControl(deviceId);}
    },{passive:true});
  }

  function updateQcPanel(card,deviceId,isOnline) {
    const btn=card.querySelector('.qc-btn'),lbl=card.querySelector('.qc-lbl');
    if(!btn||btn.classList.contains('state-pending'))return;
    const ks=devicePowerStatus[deviceId]||null;
    btn.className='qc-btn';if(lbl)lbl.className='qc-lbl';
    if(!isOnline){btn.classList.add('state-unknown');btn.disabled=true;if(lbl){lbl.classList.add('state-unknown');lbl.textContent='Offline';}}
    else if(ks==='ON'){btn.classList.add('state-on');btn.disabled=false;if(lbl){lbl.classList.add('state-on');lbl.textContent='ON';}}
    else if(ks==='OFF'){btn.classList.add('state-off');btn.disabled=false;if(lbl){lbl.classList.add('state-off');lbl.textContent='OFF';}}
    else{btn.classList.add('state-unknown');btn.disabled=false;if(lbl){lbl.classList.add('state-unknown');lbl.textContent='‚Äî';}}
  }

  function quickToggleDevice(deviceId,btn) {
    if(!mqttClient?.connected){alert('Not connected');return;}
    if(btn.classList.contains('state-pending'))return;
    const on=deviceOnlineStatus[deviceId]!=='offline'&&deviceOnlineStatus[deviceId]!=='Checking...'&&deviceOnlineStatus[deviceId]!=='unknown';
    if(!on)return;
    const lbl=btn.closest('.card-panel-control')?.querySelector('.qc-lbl');
    btn.className='qc-btn state-pending';if(lbl){lbl.className='qc-lbl state-pending';lbl.textContent='‚Ä¶';}
    if(shouldHapticAll()||shouldHapticController())hapticFeedback(getHapticIntensity());
    mqttClient.publish(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${deviceId}/control`,devicePowerStatus[deviceId]==='ON'?'0':'1');
    setTimeout(()=>{if(btn.classList.contains('state-pending')){const c=btn.closest('.device-card');if(c)updateQcPanel(c,deviceId,on);}},5000);
  }

  ;(function(){
    function bind(btnId,tipId){
      let t=null;
      document.addEventListener('DOMContentLoaded',()=>{
        const btn=document.getElementById(btnId),tip=document.getElementById(tipId);if(!btn||!tip)return;
        btn.addEventListener('mousedown', e=>{e.stopPropagation();t=setTimeout(()=>tip.style.display='block',300);});
        btn.addEventListener('touchstart',e=>{e.stopPropagation();t=setTimeout(()=>tip.style.display='block',300);},{passive:true});
        ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev,()=>{clearTimeout(t);tip.style.display='none';}));
        btn.addEventListener('click',e=>e.stopPropagation());
      });
    }
    bind('qcInfoBtn','qcTooltip'); bind('rmInfoBtn','rmTooltip');
  })();

  window.onload = init;
  window.addEventListener('pageshow', e => { if(e.persisted) init(); });
</script>
</body>
</html>
