
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AADA - Smart Home</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RESET & PERF FOUNDATIONS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after {
      margin: 0; padding: 0; box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    /* GPU-promote only what truly benefits */
    .card-track, .fab, .action-sheet, .haptics-sheet,
    .sort-sheet, .person-sheet, .action-sheet-overlay {
      will-change: transform;
    }
    /* Prevent layout thrash in the grid */
    .device-grid { contain: layout style; }
    .device-card { contain: layout style paint; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CSS CUSTOM PROPERTIES â€” THEMES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg0: #080e1c; --bg1: #0f172a; --bg2: #1e293b; --bg3: #253347;
      --card: rgba(30,41,59,0.72); --card-h: rgba(30,41,59,0.92);
      --tx0: #f8fafc; --tx1: #94a3b8; --tx2: #64748b;
      --border: rgba(255,255,255,0.08); --border-h: rgba(255,255,255,0.14);
      --ac: #0ea5e9; --ac2: #6366f1;
      --ac-glow: rgba(14,165,233,0.35); --ac-dim: rgba(14,165,233,0.12);
      --on: #10b981; --on-glow: rgba(16,185,129,0.35);
      --off: #64748b;
      --sh-md: 0 4px 14px rgba(0,0,0,0.28);
      --sh-lg: 0 10px 28px rgba(0,0,0,0.42);
      --sh-xl: 0 18px 48px rgba(0,0,0,0.55);
      --r-sm: 8px; --r-md: 12px; --r-lg: 16px; --r-xl: 24px;
      --font: 'Inter',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
    }

    /* Light */
    body.light {
      --bg0: #eef2f9; --bg1: #f8fafc; --bg2: #ffffff; --bg3: #f1f5f9;
      --card: rgba(255,255,255,0.88); --card-h: rgba(241,245,249,0.96);
      --tx0: #0f172a; --tx1: #475569; --tx2: #94a3b8;
      --border: rgba(0,0,0,0.07); --border-h: rgba(0,0,0,0.13);
      --ac: #0284c7; --ac2: #4f46e5;
      --ac-glow: rgba(2,132,199,0.25); --ac-dim: rgba(2,132,199,0.1);
      --on: #059669; --on-glow: rgba(5,150,105,0.25);
      --off: #94a3b8;
    }
    /* AMOLED */
    body[data-theme="amoled"] {
      --bg0: #000; --bg1: #050505; --bg2: #0a0a0a; --bg3: #111;
      --card: rgba(14,14,14,0.9); --card-h: rgba(22,22,22,0.95);
      --border: rgba(255,255,255,0.06);
    }
    /* Ocean */
    body[data-theme="ocean"] {
      --bg0: #020c18; --bg1: #031220; --bg2: #041c2e; --bg3: #082846;
      --card: rgba(5,20,40,0.82); --card-h: rgba(8,30,56,0.94);
    }
    /* Graphite */
    body[data-theme="graphite"] {
      --bg0: #0c0c0e; --bg1: #111113; --bg2: #18181b; --bg3: #1f1f23;
      --card: rgba(24,24,27,0.88); --card-h: rgba(32,32,36,0.96);
    }
    /* Sunset */
    body[data-theme="sunset"] {
      --bg0: #1a0a14; --bg1: #1e0f1c; --bg2: #2d1428; --bg3: #3d1c36;
      --card: rgba(35,18,32,0.82); --card-h: rgba(50,25,45,0.95);
      --border: rgba(255,200,200,0.08);
    }

    /* Accent overrides */
    body[data-accent="emerald"] { --ac:#10b981; --ac2:#059669; --ac-glow:rgba(16,185,129,.35); --ac-dim:rgba(16,185,129,.12); }
    body[data-accent="violet"]  { --ac:#8b5cf6; --ac2:#7c3aed; --ac-glow:rgba(139,92,246,.35); --ac-dim:rgba(139,92,246,.12); }
    body[data-accent="amber"]   { --ac:#f59e0b; --ac2:#d97706; --ac-glow:rgba(245,158,11,.35);  --ac-dim:rgba(245,158,11,.12); }
    body[data-accent="rose"]    { --ac:#f43f5e; --ac2:#e11d48; --ac-glow:rgba(244,63,94,.35);   --ac-dim:rgba(244,63,94,.12); }
    body[data-accent="cyan"]    { --ac:#06b6d4; --ac2:#0891b2; --ac-glow:rgba(6,182,212,.35);   --ac-dim:rgba(6,182,212,.12); }

    /* Layout â€” list mode */
    body[data-layout="list"] .device-grid {
      grid-template-columns: 1fr;
    }
    body[data-layout="list"] .device-card:not(.swipeable) {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 16px; text-align: left;
    }
    body[data-layout="list"] .device-card:not(.swipeable) .device-icon {
      margin: 0; flex-shrink: 0; width: 44px; height: 44px;
    }
    body[data-layout="list"] .device-card:not(.swipeable) .device-info {
      flex: 1; min-width: 0;
    }
    body[data-layout="list"] .device-card:not(.swipeable) .device-name { margin-bottom: 2px; }
    body[data-layout="list"] .device-card:not(.swipeable) .device-rank  { margin-bottom: 6px; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       BASE BODY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html { height: 100%; }
    body {
      font-family: var(--font);
      background: var(--bg1); color: var(--tx0);
      height: 100%; overflow: hidden; position: fixed; width: 100%;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       AMBIENT ORBS â€” disabled on low-end
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ambient {
      position: fixed; inset: 0; pointer-events: none;
      z-index: 0; overflow: hidden;
    }
    .orb {
      position: absolute; border-radius: 50%;
      filter: blur(88px); opacity: .13;
      animation: orbF 16s ease-in-out infinite alternate;
      transform: translateZ(0); /* own compositor layer */
    }
    .orb-1 { width:300px;height:300px;background:radial-gradient(circle,var(--ac),transparent);top:-70px;right:-50px; }
    .orb-2 { width:240px;height:240px;background:radial-gradient(circle,var(--ac2),transparent);bottom:12%;left:-70px;animation-delay:-7s;opacity:.08; }
    .orb-3 { width:170px;height:170px;background:radial-gradient(circle,var(--on),transparent);bottom:36%;right:6%;animation-delay:-11s;opacity:.07; }
    body.light .orb { opacity:.05; }
    /* Low-end: kill orbs entirely */
    body.low-end .ambient { display: none; }
    @keyframes orbF { to { transform: translate(22px,30px) scale(1.1) translateZ(0); } }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       APP SHELL
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app {
      position: relative; z-index: 1;
      height: 100vh; display: flex; flex-direction: column;
      max-width: 480px; margin: 0 auto;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       HEADER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: var(--bg2); flex-shrink: 0;
      padding: max(env(safe-area-inset-top),16px) 18px 0;
      position: relative;
    }
    .header::after {
      content:''; position:absolute; bottom:0; left:0; right:0; height:1px;
      background: linear-gradient(90deg,transparent,var(--border) 25%,var(--border) 75%,transparent);
    }

    .header-top {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }

    /* Brand */
    .brand { display:flex;align-items:center;gap:10px; }
    .brand-icon {
      width:34px;height:34px;border-radius:10px;flex-shrink:0;
      background:linear-gradient(135deg,var(--ac),var(--ac2));
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 0 18px var(--ac-glow);
      position:relative; overflow:hidden;
    }
    .brand-icon::after {
      content:'';position:absolute;inset:0;border-radius:10px;
      background:linear-gradient(135deg,rgba(255,255,255,.22),transparent);
    }
    .brand-icon svg { width:16px;height:16px;stroke:#fff;stroke-width:2.2;stroke-linecap:round;stroke-linejoin:round;position:relative;z-index:1; }
    .brand-text .name { font-size:15px;font-weight:700;letter-spacing:-.02em;line-height:1; }
    .brand-text .sub  { font-size:9.5px;color:var(--tx2);letter-spacing:.1em;text-transform:uppercase;margin-top:2px;font-weight:500; }

    /* Header action buttons */
    .hdr-actions { display:flex;gap:7px; }
    .hbtn {
      width:36px;height:36px;border-radius:11px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: background .18s ease, transform .13s ease;
    }
    .hbtn:active { transform:scale(0.87); }
    body:not(.low-end) .hbtn:hover { background:rgba(255,255,255,.08); }
    .hbtn svg { width:17px;height:17px;stroke:var(--tx1);stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round; }
    .hbtn.active-btn { background:var(--ac-dim);border-color:var(--ac); }
    .hbtn.active-btn svg { stroke:var(--ac); }

    /* Connection row */
    .conn-row {
      display:flex;align-items:center;justify-content:space-between;
      padding-bottom:12px;
    }
    .conn-pill {
      display:flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;
      background:rgba(255,255,255,.04);border:1px solid var(--border);
    }
    .status-dot {
      width:7px;height:7px;border-radius:50%;
      background:var(--off);
      transition: background .4s, box-shadow .4s;
    }
    .status-dot.connected {
      background:var(--on); box-shadow:0 0 8px var(--on-glow);
      animation: spulse 2.5s ease-in-out infinite;
    }
    @keyframes spulse { 0%,100%{box-shadow:0 0 5px var(--on-glow)}50%{box-shadow:0 0 13px var(--on-glow)} }
    .conn-lbl { font-size:11px;font-weight:600;letter-spacing:.04em;color:var(--tx1); }
    #userEmail { font-size:11px;color:var(--tx2);font-weight:500; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SEARCH BAR
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-wrap {
      background:var(--bg2);padding:0 18px 10px;display:none;
    }
    .search-inner {
      display:flex;align-items:center;gap:9px;
      background:var(--card);border:1px solid var(--border);border-radius:var(--r-md);
      padding:0 13px;
      transition: border-color .2s, box-shadow .2s;
    }
    .search-inner:focus-within {
      border-color:var(--ac);
      box-shadow:0 0 0 3px var(--ac-dim);
    }
    .search-inner > svg { width:15px;height:15px;stroke:var(--tx2);stroke-width:2;flex-shrink:0;stroke-linecap:round;stroke-linejoin:round; }
    .search-input {
      flex:1;background:none;border:none;outline:none;
      color:var(--tx0);font-size:14px;font-family:inherit;padding:11px 0;
    }
    .search-input::placeholder { color:var(--tx2); }
    .search-clear {
      width:22px;height:22px;border:none;border-radius:6px;
      background:rgba(255,255,255,.07);
      display:none;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .search-clear.show{display:flex;}
    .search-clear svg{width:12px;height:12px;stroke:var(--tx1);stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       FILTER CHIPS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-row {
      display:flex;gap:6px;overflow-x:auto;
      padding:9px 18px 11px;scrollbar-width:none;
      background:var(--bg2);
      border-bottom:1px solid var(--border);
      flex-shrink:0;
    }
    .filter-row::-webkit-scrollbar{display:none;}
    .chip {
      display:flex;align-items:center;gap:5px;
      padding:6px 12px;border-radius:999px;
      font-size:11.5px;font-weight:600;white-space:nowrap;
      cursor:pointer;user-select:none;
      background:rgba(255,255,255,.04);border:1px solid var(--border);
      color:var(--tx1);
      transition: all .18s ease;
    }
    .chip:active{transform:scale(.93);}
    .chip.active {
      background:var(--ac-dim);border-color:var(--ac);color:var(--ac);
    }
    .chip-dot{width:5px;height:5px;border-radius:50%;background:currentColor;}
    .chip-ct {
      background:rgba(255,255,255,.1);border-radius:8px;
      padding:1px 5px;font-size:10px;font-weight:700;min-width:17px;text-align:center;
    }
    .chip.active .chip-ct{background:var(--ac-dim);}

    /* hidden compat spans */
    #totalDevices,#onlineDevices,#offlineDevices{display:none;}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CONTENT SCROLL AREA
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .content {
      flex:1;overflow-y:auto;overflow-x:hidden;
      -webkit-overflow-scrolling:touch;scrollbar-width:none;
      padding:18px 18px 130px;
    }
    .content::-webkit-scrollbar{display:none;}

    .sec-hd {
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:16px;
    }
    .sec-title { font-size:21px;font-weight:700;letter-spacing:-.025em;color:var(--tx0); }
    .sort-btn {
      display:flex;align-items:center;gap:5px;
      padding:6px 12px;border-radius:999px;
      background:rgba(255,255,255,.04);border:1px solid var(--border);
      font-size:11.5px;font-weight:600;color:var(--tx1);
      cursor:pointer;font-family:inherit;
      transition: background .18s;
    }
    .sort-btn:active{transform:scale(.93);}
    .sort-btn svg{width:13px;height:13px;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DEVICE GRID
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .device-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:13px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DEVICE CARD â€” NORMAL
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .device-card {
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--r-lg);overflow:hidden;
      cursor:pointer;position:relative;
      opacity:0;
      animation: cIn .42s cubic-bezier(.34,1.56,.64,1) forwards;
      transition: transform .26s cubic-bezier(.34,1.56,.64,1), box-shadow .26s ease, border-color .3s;
      box-shadow:var(--sh-md);
    }
    /* Stagger delays â€” handled in JS via inline style for any count */
    .device-card:not(.swipeable) { padding:18px 15px 15px;text-align:center; }
    @keyframes cIn { from{opacity:0;transform:translateY(14px) scale(.94)} to{opacity:1;transform:none} }

    body:not(.low-end) .device-card:hover { transform:translateY(-4px);box-shadow:var(--sh-xl); }
    .device-card:active { transform:scale(.96); }

    /* Online accent stripe */
    .device-card::before {
      content:'';position:absolute;top:0;left:0;right:0;height:3px;
      background:linear-gradient(90deg,var(--ac),var(--ac2));
      opacity:0;transition:opacity .3s ease;
    }
    .device-card.online::before{opacity:1;}
    .device-card.online {
      border-color:rgba(14,165,233,.22);
      box-shadow:var(--sh-md),0 0 0 1px rgba(14,165,233,.06) inset;
    }
    body:not(.low-end) .device-card.online:hover {
      box-shadow:var(--sh-xl),0 0 22px var(--ac-glow);
    }

    /* â”€â”€ Device icon â”€â”€ */
    .device-icon {
      width:50px;height:50px;margin:0 auto 12px;
      border-radius:var(--r-md);
      background:rgba(255,255,255,.04);border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      position:relative;overflow:hidden;
      transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
    }
    .device-card.online .device-icon {
      background:linear-gradient(135deg,rgba(14,165,233,.18),rgba(99,102,241,.14));
      border-color:rgba(14,165,233,.3);
      box-shadow:0 4px 14px var(--ac-glow);
    }
    /* shimmer â€” only on capable devices */
    body:not(.low-end) .device-icon::after {
      content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);
      transition:left .6s ease;
    }
    body:not(.low-end) .device-card.online .device-icon::after{left:150%;}
    .device-icon svg {
      width:24px;height:24px;stroke:var(--tx2);stroke-width:1.8;
      transition:stroke .3s;stroke-linecap:round;stroke-linejoin:round;
    }
    .device-card.online .device-icon svg{stroke:var(--ac);}

    /* â”€â”€ Card text â”€â”€ */
    .device-info{width:100%;}
    .device-name{
      font-size:13.5px;font-weight:600;color:var(--tx0);
      margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .device-rank{font-size:10.5px;color:var(--tx2);margin-bottom:9px;font-weight:500;}
    .device-status{
      display:inline-flex;align-items:center;gap:4px;
      padding:4px 9px;border-radius:999px;
      font-size:10.5px;font-weight:600;
      transition:background .25s,color .25s;
    }
    .device-status.online  {background:rgba(16,185,129,.12);color:var(--on);}
    .device-status.offline {background:rgba(100,116,139,.12);color:var(--off);}
    .device-status.checking{background:rgba(148,163,184,.12);color:var(--tx1);}
    .status-dot-sm{
      width:5px;height:5px;border-radius:50%;background:currentColor;
      animation:sdp 2s infinite;
    }
    @keyframes sdp{0%,100%{opacity:1}50%{opacity:.35}}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       LOADING / EMPTY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading{
      grid-column:1/-1;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:72px 20px;gap:16px;
    }
    .spinner{
      width:46px;height:46px;border-radius:50%;
      border:3px solid var(--border);border-top-color:var(--ac);
      animation:spin .85s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-txt{font-size:13px;color:var(--tx1);font-weight:500;}

    .empty{
      grid-column:1/-1;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:52px 20px;gap:13px;text-align:center;
    }
    .empty-ico{
      width:68px;height:68px;border-radius:var(--r-lg);
      background:var(--card);border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
    }
    .empty-ico svg{width:30px;height:30px;stroke:var(--tx2);stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;}
    .empty-title{font-size:17px;font-weight:600;color:var(--tx0);}
    .empty-sub{font-size:12.5px;color:var(--tx2);line-height:1.55;max-width:250px;}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       FAB
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .fab{
      position:fixed;
      bottom:max(env(safe-area-inset-bottom),22px);
      right:max(calc((100vw - 480px)/2 + 18px),18px);
      width:56px;height:56px;border-radius:17px;
      background:linear-gradient(135deg,var(--ac),var(--ac2));
      box-shadow:0 8px 22px var(--ac-glow),0 2px 8px rgba(0,0,0,.4);
      border:none;cursor:pointer;z-index:50;
      display:flex;align-items:center;justify-content:center;
      transition:transform .28s cubic-bezier(.34,1.56,.64,1),box-shadow .28s ease;
    }
    .fab::before{
      content:'';position:absolute;inset:0;border-radius:17px;
      background:linear-gradient(135deg,rgba(255,255,255,.2),transparent);
    }
    body:not(.low-end) .fab:hover{transform:scale(1.09);box-shadow:0 12px 30px var(--ac-glow);}
    .fab:active{transform:scale(.91);}
    .fab svg{width:22px;height:22px;stroke:#fff;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;position:relative;z-index:1;}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       OVERLAY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.6);
      opacity:0;visibility:hidden;
      transition:opacity .26s ease,visibility .26s ease;
      z-index:200;
    }
    .overlay.show{opacity:1;visibility:visible;}
    /* backdrop-filter only on capable devices */
    body:not(.low-end) .overlay.show{
      backdrop-filter:blur(9px) saturate(1.5);
      -webkit-backdrop-filter:blur(9px) saturate(1.5);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SHEETS â€” shared base
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sheet{
      position:fixed;bottom:0;left:50%;
      width:100%;max-width:480px;
      transform:translateX(-50%) translateY(100%);
      background:var(--bg2);
      border-radius:var(--r-xl) var(--r-xl) 0 0;
      padding:0 0 max(env(safe-area-inset-bottom),22px);
      z-index:201;
      transition:transform .3s cubic-bezier(.32,.72,0,1);
      overflow:hidden;max-height:84vh;
      display:flex;flex-direction:column;
    }
    .sheet.show{transform:translateX(-50%) translateY(0);}
    .sheet::before{
      content:'';position:absolute;top:0;left:0;right:0;height:1px;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.13) 50%,transparent);
      pointer-events:none;z-index:1;
    }
    .sheet-handle{
      width:34px;height:3px;background:var(--border);
      border-radius:2px;margin:13px auto 0;flex-shrink:0;
    }
    .sheet-title{
      font-size:16.5px;font-weight:700;color:var(--tx0);
      padding:14px 18px 12px;flex-shrink:0;letter-spacing:-.02em;
    }
    .sheet-scroll{
      overflow-y:auto;flex:1;padding:0 14px;
      -webkit-overflow-scrolling:touch;scrollbar-width:none;
    }
    .sheet-scroll::-webkit-scrollbar{display:none;}

    /* â”€â”€ Sheet rows â”€â”€ */
    .srow{
      display:flex;align-items:center;gap:13px;
      padding:12px 13px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);border-radius:var(--r-md);
      margin-bottom:8px;cursor:pointer;
      transition:background .18s,transform .13s;
    }
    .srow:active{transform:scale(.98);}
    body:not(.low-end) .srow:hover{background:rgba(255,255,255,.07);}
    .srow-ico{
      width:39px;height:39px;border-radius:10px;flex-shrink:0;
      background:linear-gradient(135deg,var(--ac-dim),rgba(99,102,241,.08));
      border:1px solid rgba(14,165,233,.18);
      display:flex;align-items:center;justify-content:center;
    }
    .srow-ico svg{width:17px;height:17px;stroke:var(--ac);stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
    .srow.red .srow-ico{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2);}
    .srow.red .srow-ico svg{stroke:#ef4444;}
    .srow.red .srow-title{color:#ef4444;}
    .srow-body{flex:1;}
    .srow-title{font-size:13.5px;font-weight:600;color:var(--tx0);margin-bottom:2px;display:flex;align-items:center;gap:6px;}
    .srow-sub{font-size:11.5px;color:var(--tx1);}

    /* toggle icon anim */
    #themeIco.rot svg{transform:rotate(180deg);}
    .srow-ico svg{transition:transform .38s ease;}

    /* â”€â”€ Toggle switch â”€â”€ */
    .tog{position:relative;width:42px;height:24px;flex-shrink:0;}
    .tog input{opacity:0;width:0;height:0;position:absolute;}
    .tog-sl{
      position:absolute;inset:0;border-radius:12px;
      background:var(--tx2);cursor:pointer;
      transition:background .28s ease;
    }
    .tog-sl::before{
      content:'';position:absolute;
      width:18px;height:18px;left:3px;bottom:3px;
      background:#fff;border-radius:50%;
      box-shadow:0 1px 4px rgba(0,0,0,.3);
      transition:transform .28s cubic-bezier(.34,1.56,.64,1);
    }
    .tog input:checked+.tog-sl{background:linear-gradient(90deg,var(--ac),var(--ac2));}
    .tog input:checked+.tog-sl::before{transform:translateX(18px);}

    /* â”€â”€ Info badge â”€â”€ */
    .ibadge{
      display:inline-flex;align-items:center;justify-content:center;
      width:14px;height:14px;border-radius:50%;
      background:rgba(148,163,184,.2);color:var(--tx2);
      font-size:8.5px;font-weight:700;font-style:italic;
      font-family:Georgia,serif;cursor:pointer;flex-shrink:0;
      user-select:none;
    }

    /* â”€â”€ Haptics â”€â”€ */
    .hap-row{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 13px;
      background:rgba(255,255,255,.04);border:1px solid var(--border);
      border-radius:var(--r-md);margin-bottom:8px;
    }
    .hap-lbl{display:flex;align-items:center;gap:9px;cursor:pointer;flex:1;}
    .hap-lbl input[type=checkbox]{width:17px;height:17px;accent-color:var(--ac);cursor:pointer;}
    .hap-lbl span{font-size:13px;color:var(--tx0);font-weight:500;}
    .int-box{
      padding:13px;background:rgba(255,255,255,.04);
      border:1px solid var(--border);border-radius:var(--r-md);margin-bottom:8px;
    }
    .int-title{font-size:12.5px;font-weight:600;color:var(--tx0);margin-bottom:13px;}
    .int-row{display:flex;align-items:center;gap:11px;}
    .range-input{
      flex:1;-webkit-appearance:none;height:4px;border-radius:2px;
      background:var(--border);outline:none;cursor:pointer;
    }
    .range-input::-webkit-slider-thumb{
      -webkit-appearance:none;width:19px;height:19px;border-radius:50%;
      background:linear-gradient(135deg,var(--ac),var(--ac2));
      box-shadow:0 0 9px var(--ac-glow);border:2px solid var(--bg2);cursor:pointer;
    }
    .range-input::-moz-range-thumb{
      width:19px;height:19px;border-radius:50%;
      background:linear-gradient(135deg,var(--ac),var(--ac2));
      border:2px solid var(--bg2);
    }
    .int-val{font-size:11.5px;color:var(--tx1);min-width:42px;font-weight:600;text-align:right;}

    /* â”€â”€ Sort options â”€â”€ */
    .sort-opt{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 13px;
      background:rgba(255,255,255,.04);border:1px solid var(--border);
      border-radius:var(--r-md);margin-bottom:8px;
      cursor:pointer;transition:all .18s;
    }
    .sort-opt:active{transform:scale(.98);}
    .sort-opt.active{background:var(--ac-dim);border-color:var(--ac);}
    .sort-opt.active .sot{color:var(--ac);}
    .sort-opt.active .sod{color:rgba(14,165,233,.7);}
    .sot{font-size:13.5px;font-weight:600;color:var(--tx0);margin-bottom:2px;}
    .sod{font-size:11.5px;color:var(--tx1);}
    .schk{
      width:21px;height:21px;border-radius:50%;
      border:1.5px solid var(--border);
      display:flex;align-items:center;justify-content:center;transition:all .2s;
    }
    .sort-opt.active .schk{background:var(--ac);border-color:var(--ac);}
    .schk svg{width:11px;height:11px;stroke:#fff;stroke-width:3;opacity:0;transition:opacity .2s;stroke-linecap:round;stroke-linejoin:round;}
    .sort-opt.active .schk svg{opacity:1;}

    /* â”€â”€ Personalize sheet â”€â”€ */
    .plabel{
      font-size:10.5px;font-weight:700;letter-spacing:.1em;
      text-transform:uppercase;color:var(--tx2);margin:4px 0 9px;
    }

    /* Theme swatches */
    .theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:13px;}
    .tswatch{
      aspect-ratio:1;border-radius:var(--r-md);cursor:pointer;
      border:2px solid transparent;
      transition:border-color .2s,box-shadow .2s,transform .15s;
      position:relative;overflow:hidden;
    }
    .tswatch.active{border-color:var(--ac);box-shadow:0 0 12px var(--ac-glow);}
    .tswatch:active{transform:scale(.92);}
    .tslbl{
      position:absolute;bottom:0;left:0;right:0;
      padding:4px;font-size:9px;font-weight:700;text-align:center;
      background:rgba(0,0,0,.5);letter-spacing:.05em;text-transform:uppercase;
    }

    /* Accent dots */
    .accent-row{display:flex;gap:8px;margin-bottom:13px;flex-wrap:wrap;align-items:center;}
    .adot{
      width:30px;height:30px;border-radius:50%;cursor:pointer;
      border:2px solid transparent;
      transition:transform .18s,border-color .18s;
    }
    .adot.active{border-color:#fff;transform:scale(1.18);}
    .adot:active{transform:scale(.88);}

    /* Layout toggle row */
    .layout-row{
      display:flex;gap:7px;margin-bottom:14px;
    }
    .layout-opt{
      flex:1;display:flex;flex-direction:column;align-items:center;gap:7px;
      padding:12px 8px;border-radius:var(--r-md);cursor:pointer;
      background:rgba(255,255,255,.04);border:2px solid var(--border);
      transition:all .2s;
    }
    .layout-opt.active{background:var(--ac-dim);border-color:var(--ac);}
    .layout-opt:active{transform:scale(.95);}
    .layout-opt svg{width:22px;height:22px;stroke:var(--tx2);stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round;transition:stroke .2s;}
    .layout-opt.active svg{stroke:var(--ac);}
    .layout-opt span{font-size:10.5px;font-weight:700;color:var(--tx2);letter-spacing:.04em;text-transform:uppercase;transition:color .2s;}
    .layout-opt.active span{color:var(--ac);}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SWIPEABLE CARDS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .device-card.swipeable{padding:0;cursor:default;text-align:left;}
    body:not(.low-end) .device-card.swipeable:hover{transform:none;}

    .card-track{
      display:flex;width:200%;
      transition:transform .3s cubic-bezier(.4,0,.2,1);
    }
    .card-track.revealed{transform:translateX(-50%);}

    .cp{width:50%;flex-shrink:0;display:flex;flex-direction:column;align-items:center;}
    .cp-info{padding:18px 15px 15px;position:relative;text-align:center;}
    .cp-info .device-name{width:100%;}
    .cp-ctrl{justify-content:center;gap:9px;padding:18px 15px;}

    .swipe-hint{
      position:absolute;right:7px;top:50%;transform:translateY(-50%);
      pointer-events:none;opacity:0;
      animation:sha .5s ease 1.3s forwards,shb 2s ease-in-out 1.8s infinite;
    }
    .swipe-hint svg{width:12px;height:12px;stroke:var(--tx2);stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;}
    .card-track.revealed .swipe-hint{display:none;}
    @keyframes sha{to{opacity:.45}}
    @keyframes shb{0%,100%{transform:translateY(-50%) translateX(0);opacity:.45}50%{transform:translateY(-50%) translateX(-4px);opacity:.75}}

    .qc-back{position:absolute;left:7px;top:50%;transform:translateY(-50%);pointer-events:none;opacity:.28;}
    .qc-back svg{width:12px;height:12px;stroke:var(--tx2);stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;}

    /* Power button */
    .qpbtn{
      width:60px;height:60px;border-radius:50%;border:none;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:transform .17s ease,box-shadow .24s ease;
    }
    .qpbtn:active{transform:scale(.87);}
    .qpbtn.state-on  {background:linear-gradient(145deg,#059669,#10b981);box-shadow:0 0 0 6px rgba(16,185,129,.14),0 6px 18px rgba(16,185,129,.42);}
    .qpbtn.state-off {background:linear-gradient(145deg,#0369a1,var(--ac));box-shadow:0 0 0 6px var(--ac-dim),0 6px 18px var(--ac-glow);}
    .qpbtn.state-pending{
      background:linear-gradient(145deg,#0891b2,#06b6d4);
      box-shadow:0 0 0 6px rgba(6,182,212,.14),0 6px 18px rgba(6,182,212,.38);
      cursor:default;animation:pring 1.1s ease-in-out infinite;
    }
    .qpbtn.state-unknown{background:linear-gradient(145deg,#1e3a4f,#2d5a7a);box-shadow:0 0 0 5px var(--ac-dim);}
    @keyframes pring{0%,100%{box-shadow:0 0 0 6px rgba(6,182,212,.14),0 6px 18px rgba(6,182,212,.38)}50%{box-shadow:0 0 0 11px rgba(6,182,212,.22),0 6px 24px rgba(6,182,212,.55)}}
    .qpico{width:23px;height:23px;stroke:#fff;stroke-width:2.5;fill:none;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 1px 3px rgba(0,0,0,.28));}
    .qpbtn.state-pending .qpico{opacity:.65;}
    .qplbl{font-size:9px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;}
    .qplbl.state-on{color:var(--on)}.qplbl.state-off{color:var(--ac)}.qplbl.state-pending{color:#06b6d4}.qplbl.state-unknown{color:var(--tx2)}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       TOOLTIP
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tooltip{
      display:none;position:fixed;bottom:84px;left:50%;transform:translateX(-50%);
      background:var(--bg2);border:1px solid var(--border);
      color:var(--tx0);font-size:12px;font-weight:500;line-height:1.5;
      padding:9px 13px;border-radius:var(--r-md);
      box-shadow:var(--sh-lg);max-width:255px;width:max-content;
      text-align:center;z-index:9999;pointer-events:none;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RESPONSIVE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media(max-width:375px){
      .device-grid{grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:11px;}
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       LOW-END OVERRIDES
       Kills all non-essential animations/effects
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.low-end .device-card{animation:none;opacity:1;}
    body.low-end .device-card::before{display:none;}
    body.low-end .fab{transition:transform .15s,box-shadow .15s;}
    body.low-end .card-track{transition:transform .22s ease;}
    body.low-end .sheet{transition:transform .22s ease;}
    body.low-end .swipe-hint{display:none;}
    body.low-end .spinner{animation:spin .7s linear infinite;}
    body.low-end *{transition-duration:.15s!important;}
    body.low-end .orb{animation:none;}
  </style>
</head>
<body>

  <!-- Ambient background orbs -->
  <div class="ambient">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <div class="app">

    <!-- â•â• HEADER â•â• -->
    <div class="header">
      <div class="header-top">
        <div class="brand">
          <div class="brand-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </div>
          <div class="brand-text">
            <div class="name">AADAconnect</div>
            <div class="sub">Smart Home</div>
          </div>
        </div>
        <div class="hdr-actions">
          <div class="hbtn" id="searchToggleBtn" title="Search">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </div>
          <div class="hbtn" id="layoutBtn" title="Toggle layout">
            <svg id="layoutIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          </div>
          <div class="hbtn" id="moreBtn" title="More options">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="5" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="19" r="1" fill="currentColor" stroke="none"/></svg>
          </div>
        </div>
      </div>
      <div class="conn-row">
        <div class="conn-pill">
          <div class="status-dot" id="mqttStatus"></div>
          <span class="conn-lbl" id="connLabel">Connectingâ€¦</span>
        </div>
        <span id="userEmail">â€”</span>
      </div>
    </div>

    <!-- â•â• SEARCH â•â• -->
    <div class="search-wrap" id="searchContainer">
      <div class="search-inner">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" id="searchInput" type="text" placeholder="Search devicesâ€¦" autocomplete="off">
        <button class="search-clear" id="clearSearch">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>

    <!-- â•â• FILTER CHIPS â•â• -->
    <div class="filter-row">
      <div class="chip active" data-filter="all">All <span class="chip-ct" id="fc-total">0</span></div>
      <div class="chip" data-filter="online"><span class="chip-dot"></span>Online <span class="chip-ct" id="fc-online">0</span></div>
      <div class="chip" data-filter="offline"><span class="chip-dot"></span>Offline <span class="chip-ct" id="fc-offline">0</span></div>
    </div>

    <!-- hidden compat spans -->
    <span id="totalDevices" style="display:none"></span>
    <span id="onlineDevices" style="display:none"></span>
    <span id="offlineDevices" style="display:none"></span>

    <!-- â•â• CONTENT â•â• -->
    <div class="content">
      <div class="sec-hd">
        <div class="sec-title">My Devices</div>
        <button class="sort-btn" id="sortBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="3" y1="6" x2="21" y2="6"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
          <span id="sortLabel">Rank</span>
        </button>
      </div>
      <div class="device-grid" id="deviceGrid">
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-txt">Loading devicesâ€¦</div>
        </div>
      </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="addDeviceBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- â•â• MAIN SHEET â•â• -->
    <div class="sheet" id="actionSheet">
      <div class="sheet-handle"></div>
      <div class="sheet-title">Options</div>
      <div class="sheet-scroll">

        <div class="srow" id="refreshItem">
          <div class="srow-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></div>
          <div class="srow-body"><div class="srow-title">Refresh Devices</div><div class="srow-sub">Update all device statuses</div></div>
        </div>

        <div class="srow" id="themeToggleItem">
          <div class="srow-ico" id="themeIco"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
          <div class="srow-body"><div class="srow-title">Toggle Theme</div><div class="srow-sub">Switch light / dark mode</div></div>
        </div>

        <div class="srow" id="hapticsItem">
          <div class="srow-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg></div>
          <div class="srow-body"><div class="srow-title">Haptic Feedback</div><div class="srow-sub">Configure vibration settings</div></div>
        </div>

        <div class="srow" id="personItem">
          <div class="srow-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></div>
          <div class="srow-body"><div class="srow-title">Personalize</div><div class="srow-sub">Theme, accent, layout &amp; more</div></div>
        </div>

        <div class="srow" id="quickControlItem" style="cursor:default;">
          <div class="srow-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg></div>
          <div class="srow-body">
            <div class="srow-title">Quick Device Control <span class="ibadge" id="qcInfoBtn">i</span></div>
            <div class="srow-sub">Swipe cards to control power</div>
          </div>
          <label class="tog" onclick="event.stopPropagation()">
            <input type="checkbox" id="quickControlToggle" onchange="toggleQuickControl(this.checked)">
            <span class="tog-sl"></span>
          </label>
        </div>

        <div class="srow" id="rememberMeItem" style="cursor:default;">
          <div class="srow-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
          <div class="srow-body">
            <div class="srow-title">Remember Me <span class="ibadge" id="rmInfoBtn">i</span></div>
            <div class="srow-sub">Auto-login on next visit</div>
          </div>
          <label class="tog" onclick="event.stopPropagation()">
            <input type="checkbox" id="rememberMeToggle" onchange="toggleRememberMe(this.checked)">
            <span class="tog-sl"></span>
          </label>
        </div>

        <div class="srow red" id="logoutItem">
          <div class="srow-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
          <div class="srow-body"><div class="srow-title">Logout</div><div class="srow-sub">Sign out of your account</div></div>
        </div>

        <div style="height:8px"></div>
      </div>
    </div>

    <!-- â•â• HAPTICS SHEET â•â• -->
    <div class="sheet" id="hapticsSheet">
      <div class="sheet-handle"></div>
      <div class="sheet-title">Haptic Feedback</div>
      <div class="sheet-scroll">
        <div class="hap-row">
          <label class="hap-lbl"><input type="checkbox" id="hapticsController"><span>Controller on/off button</span></label>
        </div>
        <div class="hap-row">
          <label class="hap-lbl"><input type="checkbox" id="hapticsAll"><span>All buttons</span></label>
        </div>
        <div class="int-box">
          <div class="int-title">Haptic Intensity</div>
          <div class="int-row">
            <input type="range" id="hapticsIntensity" min="10" max="200" step="10" value="50" class="range-input">
            <span class="int-val" id="intensityValue">50ms</span>
          </div>
        </div>
        <div style="height:8px"></div>
      </div>
    </div>

    <!-- â•â• SORT SHEET â•â• -->
    <div class="sheet" id="sortSheet">
      <div class="sheet-handle"></div>
      <div class="sheet-title">Sort Devices</div>
      <div class="sheet-scroll">
        <div class="sort-opt active" data-sort="rank">
          <div><div class="sot">By Rank</div><div class="sod">Ordered by device rank number</div></div>
          <div class="schk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        <div class="sort-opt" data-sort="name">
          <div><div class="sot">By Name</div><div class="sod">Alphabetical order</div></div>
          <div class="schk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        <div class="sort-opt" data-sort="status">
          <div><div class="sot">By Status</div><div class="sod">Online devices first</div></div>
          <div class="schk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        <div class="sort-opt" data-sort="recent">
          <div><div class="sot">Recently Added</div><div class="sod">Newest devices first</div></div>
          <div class="schk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        <div style="height:8px"></div>
      </div>
    </div>

    <!-- â•â• PERSONALIZE SHEET â•â• -->
    <div class="sheet" id="personSheet">
      <div class="sheet-handle"></div>
      <div class="sheet-title">Personalize</div>
      <div class="sheet-scroll">

        <!-- Themes -->
        <div class="plabel">Theme</div>
        <div class="theme-grid">
          <div class="tswatch" data-theme="default" style="background:linear-gradient(135deg,#0f172a 40%,#1e293b)">
            <div class="tslbl" style="color:#fff">Default</div>
          </div>
          <div class="tswatch" data-theme="amoled" style="background:#000">
            <div class="tslbl" style="color:#fff">AMOLED</div>
          </div>
          <div class="tswatch" data-theme="ocean" style="background:linear-gradient(135deg,#020c18,#041c2e)">
            <div class="tslbl" style="color:#fff">Ocean</div>
          </div>
          <div class="tswatch" data-theme="graphite" style="background:linear-gradient(135deg,#111113,#18181b)">
            <div class="tslbl" style="color:#fff">Graphite</div>
          </div>
          <div class="tswatch" data-theme="sunset" style="background:linear-gradient(135deg,#1a0a14,#3d1c36)">
            <div class="tslbl" style="color:#fff">Sunset</div>
          </div>
          <div class="tswatch" data-theme="light" style="background:linear-gradient(135deg,#f8fafc,#e2e8f0)">
            <div class="tslbl" style="color:#222">Light</div>
          </div>
        </div>

        <!-- Accent colors -->
        <div class="plabel">Accent Color</div>
        <div class="accent-row">
          <div class="adot" data-accent="default" style="background:linear-gradient(135deg,#0ea5e9,#6366f1)" title="Sky"></div>
          <div class="adot" data-accent="cyan"    style="background:linear-gradient(135deg,#06b6d4,#0891b2)" title="Cyan"></div>
          <div class="adot" data-accent="emerald" style="background:linear-gradient(135deg,#10b981,#059669)" title="Emerald"></div>
          <div class="adot" data-accent="violet"  style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)" title="Violet"></div>
          <div class="adot" data-accent="amber"   style="background:linear-gradient(135deg,#f59e0b,#d97706)" title="Amber"></div>
          <div class="adot" data-accent="rose"    style="background:linear-gradient(135deg,#f43f5e,#e11d48)" title="Rose"></div>
        </div>

        <!-- Layout -->
        <div class="plabel">Layout</div>
        <div class="layout-row">
          <div class="layout-opt" data-layout="grid">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            <span>Grid</span>
          </div>
          <div class="layout-opt" data-layout="list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            <span>List</span>
          </div>
        </div>

        <div style="height:8px"></div>
      </div>
    </div>

    <!-- Tooltips -->
    <div id="qcTooltip" class="tooltip">ðŸ’¡ Swipe a card <strong>left</strong> to reveal quick power controls</div>
    <div id="rmTooltip"  class="tooltip">ðŸ” Auto-login on next visit â€” skips the login screen</div>

  </div><!-- /app -->

  <script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PERF: Low-end detection (run before anything)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function(){
    // Heuristic: â‰¤4 cores OR small RAM (if available)
    const lowEnd = navigator.hardwareConcurrency <= 4 ||
      (navigator.deviceMemory !== undefined && navigator.deviceMemory <= 2);
    if (lowEnd) document.body.classList.add('low-end');
  })();

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HAPTICS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function hapticFeedback(duration) {
    if ('vibrate' in navigator && duration > 0) navigator.vibrate(duration);
  }
  function getHapticIntensity() { return parseInt(localStorage.getItem('hapticsIntensity') || '50'); }
  function shouldHapticAll()        { return localStorage.getItem('hapticsAll') === 'true'; }
  function shouldHapticController() { return localStorage.getItem('hapticsController') === 'true'; }
  function addHapticToElement(el, cb) {
    el.addEventListener('click', function(e){
      if (shouldHapticAll()) hapticFeedback(getHapticIntensity());
      if (cb) cb(e);
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // GLOBALS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let mqttClient       = null;
  let devices          = [];
  let currentUser      = null;
  let deviceOnlineStatus = {};
  let deviceTimeouts   = {};
  let deviceListTimeout = null;
  let renderTimeout    = null;
  let currentSortBy    = localStorage.getItem('sortBy') || 'rank';
  let currentFilter    = 'all';
  let searchQuery      = '';
  let devicePowerStatus = {};
  let deviceSwipeState  = {};

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // INIT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function init() {
    currentUser = JSON.parse(sessionStorage.getItem('current_user') || 'null');
    if (!currentUser) {
      const r = localStorage.getItem('remembered_user');
      if (r) { try { currentUser = JSON.parse(r); sessionStorage.setItem('current_user', r); } catch(e){} }
    }
    if (!currentUser) { window.location.href = 'login.html'; return; }

    document.getElementById('userEmail').textContent = currentUser.email;
    loadTheme();
    setupEventListeners();
    connectMQTT();
    loadHapticsSettings();

    currentSortBy = localStorage.getItem('sortBy') || 'rank';
    updateSortLabel();
    document.querySelectorAll('.sort-opt').forEach(o => o.classList.remove('active'));
    const so = document.querySelector(`.sort-opt[data-sort="${currentSortBy}"]`);
    if (so) so.classList.add('active');

    document.getElementById('quickControlToggle').checked = localStorage.getItem('quickControl') === 'true';
    document.getElementById('rememberMeToggle').checked   = localStorage.getItem('rememberMe') === 'true';

    syncLayoutBtn();
    syncPersonalizeUI();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // THEME / ACCENT / LAYOUT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadTheme() {
    applyTheme(localStorage.getItem('theme') || 'default');
    applyAccent(localStorage.getItem('accent') || 'default');
    applyLayout(localStorage.getItem('layout') || 'grid');
  }

  function applyTheme(t) {
    document.body.classList.remove('light');
    document.body.removeAttribute('data-theme');
    if (t === 'light') document.body.classList.add('light');
    else if (t !== 'default') document.body.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
  }

  function applyAccent(a) {
    document.body.removeAttribute('data-accent');
    if (a !== 'default') document.body.setAttribute('data-accent', a);
    localStorage.setItem('accent', a);
  }

  function applyLayout(l) {
    if (l === 'list') document.body.setAttribute('data-layout', 'list');
    else document.body.removeAttribute('data-layout');
    localStorage.setItem('layout', l);
    syncLayoutBtn();
  }

  function syncLayoutBtn() {
    const l = localStorage.getItem('layout') || 'grid';
    const btn = document.getElementById('layoutBtn');
    const ico = document.getElementById('layoutIcon');
    if (l === 'list') {
      btn.classList.add('active-btn');
      ico.innerHTML = '<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';
    } else {
      btn.classList.remove('active-btn');
      ico.innerHTML = '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>';
    }
  }

  function syncPersonalizeUI() {
    const t = localStorage.getItem('theme')  || 'default';
    const a = localStorage.getItem('accent') || 'default';
    const l = localStorage.getItem('layout') || 'grid';
    document.querySelectorAll('.tswatch').forEach(s => s.classList.toggle('active', s.dataset.theme === t));
    document.querySelectorAll('.adot').forEach(d => d.classList.toggle('active', d.dataset.accent === a));
    document.querySelectorAll('.layout-opt').forEach(o => o.classList.toggle('active', o.dataset.layout === l));
  }

  function toggleTheme() {
    const ico = document.getElementById('themeIco');
    ico.classList.add('rot');
    const cur = localStorage.getItem('theme') || 'default';
    const next = cur === 'light' ? 'default' : 'light';
    applyTheme(next);
    syncPersonalizeUI();
    setTimeout(() => { ico.classList.remove('rot'); closeAllSheets(); }, 380);
  }

  function toggleLayout() {
    const cur = localStorage.getItem('layout') || 'grid';
    applyLayout(cur === 'list' ? 'grid' : 'list');
    syncPersonalizeUI();
    // Re-render only if needed (list â†’ grid cards already in DOM, just re-layout via CSS)
    // But swipeable cards need padding reset, so re-render is safest:
    renderDevices();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EVENT LISTENERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupEventListeners() {
    addHapticToElement(document.getElementById('moreBtn'), showActionSheet);
    addHapticToElement(document.getElementById('addDeviceBtn'), addDevice);
    addHapticToElement(document.getElementById('searchToggleBtn'), toggleSearch);
    addHapticToElement(document.getElementById('sortBtn'), showSortSheet);
    addHapticToElement(document.getElementById('layoutBtn'), toggleLayout);

    document.getElementById('overlay').addEventListener('click', closeAllSheets);

    addHapticToElement(document.getElementById('refreshItem'),     refreshDevices);
    addHapticToElement(document.getElementById('themeToggleItem'), toggleTheme);
    addHapticToElement(document.getElementById('hapticsItem'),     showHapticsSheet);
    addHapticToElement(document.getElementById('personItem'),      showPersonSheet);
    addHapticToElement(document.getElementById('logoutItem'),      logout);

    // Haptics
    document.getElementById('hapticsIntensity').addEventListener('input', function(){
      updateIntensityDisplay(); saveHapticsSettings();
      hapticFeedback(parseInt(this.value));
    });
    document.getElementById('hapticsController').addEventListener('change', saveHapticsSettings);
    document.getElementById('hapticsAll').addEventListener('change', saveHapticsSettings);

    // Search
    const si = document.getElementById('searchInput');
    si.addEventListener('input', e => {
      searchQuery = e.target.value.toLowerCase();
      document.getElementById('clearSearch').classList.toggle('show', searchQuery.length > 0);
      renderDevices();
    });
    document.getElementById('clearSearch').addEventListener('click', () => {
      si.value = ''; searchQuery = '';
      document.getElementById('clearSearch').classList.remove('show');
      renderDevices();
    });

    // Filter chips
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        renderDevices();
      });
    });

    // Sort options
    document.querySelectorAll('.sort-opt').forEach(opt => {
      addHapticToElement(opt, () => {
        document.querySelectorAll('.sort-opt').forEach(o => o.classList.remove('active'));
        opt.classList.add('active');
        currentSortBy = opt.dataset.sort;
        localStorage.setItem('sortBy', currentSortBy);
        updateSortLabel(); renderDevices();
        setTimeout(hideSortSheet, 280);
      });
    });

    // Theme swatches
    document.querySelectorAll('.tswatch').forEach(sw => {
      sw.addEventListener('click', () => {
        applyTheme(sw.dataset.theme);
        syncPersonalizeUI();
      });
    });

    // Accent dots
    document.querySelectorAll('.adot').forEach(dot => {
      dot.addEventListener('click', () => {
        applyAccent(dot.dataset.accent);
        syncPersonalizeUI();
      });
    });

    // Layout opts in personalize sheet
    document.querySelectorAll('.layout-opt').forEach(opt => {
      opt.addEventListener('click', () => {
        applyLayout(opt.dataset.layout);
        syncPersonalizeUI();
        renderDevices();
      });
    });

    // Tooltips (hold)
    setupTooltip('qcInfoBtn', 'qcTooltip');
    setupTooltip('rmInfoBtn',  'rmTooltip');
  }

  function setupTooltip(btnId, tipId) {
    let t = null;
    const btn = document.getElementById(btnId);
    const tip = document.getElementById(tipId);
    if (!btn || !tip) return;
    const show = () => { tip.style.display = 'block'; };
    const hide = () => { clearTimeout(t); tip.style.display = 'none'; };
    btn.addEventListener('mousedown',   e => { e.stopPropagation(); t = setTimeout(show, 300); });
    btn.addEventListener('touchstart',  e => { e.stopPropagation(); t = setTimeout(show, 300); }, {passive:true});
    btn.addEventListener('mouseup',     hide);
    btn.addEventListener('mouseleave',  hide);
    btn.addEventListener('touchend',    hide);
    btn.addEventListener('touchcancel', hide);
    btn.addEventListener('click',       e => e.stopPropagation());
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SEARCH TOGGLE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleSearch() {
    const c = document.getElementById('searchContainer');
    const open = c.style.display === 'block';
    c.style.display = open ? 'none' : 'block';
    if (!open) {
      document.getElementById('searchInput').focus();
      document.getElementById('searchToggleBtn').classList.add('active-btn');
    } else {
      document.getElementById('searchInput').value = '';
      searchQuery = '';
      document.getElementById('searchToggleBtn').classList.remove('active-btn');
      renderDevices();
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SHEETS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SHEETS = ['actionSheet','hapticsSheet','sortSheet','personSheet'];

  function openSheet(id) {
    document.getElementById('overlay').classList.add('show');
    document.getElementById(id).classList.add('show');
  }
  function closeAllSheets() {
    document.getElementById('overlay').classList.remove('show');
    SHEETS.forEach(id => document.getElementById(id).classList.remove('show'));
  }

  function showActionSheet()  { openSheet('actionSheet'); }
  function hideActionSheet()  { closeAllSheets(); }
  function showHapticsSheet() { closeAllSheets(); loadHapticsSettings(); updateIntensityDisplay(); openSheet('hapticsSheet'); }
  function hideHapticsSheet() { closeAllSheets(); }
  function showSortSheet() {
    document.querySelectorAll('.sort-opt').forEach(o => o.classList.remove('active'));
    const el = document.querySelector(`.sort-opt[data-sort="${currentSortBy}"]`);
    if (el) el.classList.add('active');
    openSheet('sortSheet');
  }
  function hideSortSheet()  { closeAllSheets(); }
  function showPersonSheet() { syncPersonalizeUI(); openSheet('personSheet'); }

  function updateSortLabel() {
    document.getElementById('sortLabel').textContent =
      {rank:'Rank',name:'Name',status:'Status',recent:'Recent'}[currentSortBy] || 'Rank';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HAPTICS SETTINGS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadHapticsSettings() {
    document.getElementById('hapticsController').checked = localStorage.getItem('hapticsController') === 'true';
    document.getElementById('hapticsAll').checked        = localStorage.getItem('hapticsAll') === 'true';
    document.getElementById('hapticsIntensity').value   = getHapticIntensity();
    updateIntensityDisplay();
  }
  function updateIntensityDisplay() {
    document.getElementById('intensityValue').textContent = document.getElementById('hapticsIntensity').value + 'ms';
  }
  function saveHapticsSettings() {
    localStorage.setItem('hapticsController', document.getElementById('hapticsController').checked);
    localStorage.setItem('hapticsAll',        document.getElementById('hapticsAll').checked);
    localStorage.setItem('hapticsIntensity',  document.getElementById('hapticsIntensity').value);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MQTT â€” EXACT from original
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function connectMQTT() {
    const dot   = document.getElementById('mqttStatus');
    const label = document.getElementById('connLabel');
    try {
      mqttClient = mqtt.connect('wss://y1dda1f8.ala.asia-southeast1.emqxsl.com:8084/mqtt', {
        username: 'AADAconnect',
        password: 'wMhtXcU86UtV-48'
      });

      mqttClient.on('connect', () => {
        dot.className   = 'status-dot connected';
        label.textContent = 'Connected';
        const fetchTopic = `smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/fetch`;
        mqttClient.subscribe(fetchTopic, err => {
          if (!err) {
            deviceListTimeout = setTimeout(() => { if (devices.length === 0) renderDevices(); }, 5000);
          }
        });
      });

      mqttClient.on('message', (topic, message) => handleMQTTMessage(topic, message));

      mqttClient.on('error', () => {
        dot.className = 'status-dot'; label.textContent = 'Offline';
        if (devices.length === 0) renderDevices();
      });
      mqttClient.on('close', () => {
        dot.className = 'status-dot'; label.textContent = 'Offline';
        if (devices.length === 0) renderDevices();
      });
    } catch(e) {
      document.getElementById('mqttStatus').className = 'status-dot';
      document.getElementById('connLabel').textContent = 'Offline';
      renderDevices();
    }
  }

  function handleMQTTMessage(topic, message) {
    const parts = topic.split('/');
    try {
      const data = JSON.parse(message.toString());
      if (data.device_list && Array.isArray(data.device_list)) {
        clearTimeout(deviceListTimeout);
        devices = data.device_list;
        renderDevices();
        devices.forEach(d => {
          mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/status`);
          mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/OF`);
        });
        checkAllDevicesStatus();
      }
    } catch(e) {}

    // OF topic â†’ online/offline
    if (parts[parts.length - 1] === 'OF') {
      const id  = parts[parts.length - 2];
      const raw = message.toString().trim();
      const lo  = raw.toLowerCase();
      if (lo === 'check_status') return;
      if (deviceTimeouts[id]) { clearTimeout(deviceTimeouts[id]); delete deviceTimeouts[id]; }
      const msg = lo === 'offline' ? 'offline' : raw;
      deviceOnlineStatus[id] = msg;
      updateDeviceOnlineStatus(id, msg, lo !== 'offline');
    }

    // status topic â†’ ON/OFF for quick control
    if (parts[parts.length - 1] === 'status') {
      const id = parts[parts.length - 2];
      const st = message.toString().trim().toUpperCase();
      if (st === 'ON' || st === 'OFF') {
        devicePowerStatus[id] = st;
        document.querySelectorAll(`.device-card[data-device-id="${id}"]`).forEach(card => {
          const online = deviceOnlineStatus[id] !== 'offline' && deviceOnlineStatus[id] !== 'Checking...';
          updateQcPanel(card, id, online);
        });
      }
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // STATS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStats() {
    const total  = devices.length;
    const online = devices.filter(d => {
      const s = deviceOnlineStatus[d.device_id];
      return s && s !== 'offline' && s !== 'Checking...';
    }).length;
    const offline = total - online;
    // compat hidden spans
    document.getElementById('totalDevices').textContent   = total;
    document.getElementById('onlineDevices').textContent  = online;
    document.getElementById('offlineDevices').textContent = offline;
    // visible chip counts
    document.getElementById('fc-total').textContent   = total;
    document.getElementById('fc-online').textContent  = online;
    document.getElementById('fc-offline').textContent = offline;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SORT + FILTER â€” exact from original
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sortDevices(arr) {
    let s = [...arr];
    if (currentSortBy === 'name')   s.sort((a,b) => a.device_id.localeCompare(b.device_id));
    else if (currentSortBy === 'status') {
      const on  = s.filter(d => deviceOnlineStatus[d.device_id] !== 'offline' && deviceOnlineStatus[d.device_id] !== 'Checking...');
      const off = s.filter(d => deviceOnlineStatus[d.device_id] === 'offline'  || deviceOnlineStatus[d.device_id] === 'Checking...');
      s = [...on, ...off];
    } else if (currentSortBy === 'recent') s.reverse();
    else s.sort((a,b) => a.device_rank - b.device_rank);
    return s;
  }

  function filterDevices(arr) {
    let f = arr;
    if (searchQuery) f = f.filter(d => d.device_id.toLowerCase().includes(searchQuery));
    if (currentFilter === 'online')  f = f.filter(d => deviceOnlineStatus[d.device_id] !== 'offline' && deviceOnlineStatus[d.device_id] !== 'Checking...');
    if (currentFilter === 'offline') f = f.filter(d => deviceOnlineStatus[d.device_id] === 'offline'  || deviceOnlineStatus[d.device_id] === 'Checking...');
    return f;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RENDER DEVICES
  // Uses DocumentFragment for a single DOM write â€” no jank
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDevices() {
    if (renderTimeout) clearTimeout(renderTimeout);
    renderTimeout = setTimeout(_doRender, 60);
  }

  function _doRender() {
    const grid = document.getElementById('deviceGrid');
    updateStats();

    const EMPTY_SVG_PLUS = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12h6M12 9v6"/></svg>`;
    const EMPTY_SVG_SRCH = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`;

    if (devices.length === 0) {
      grid.innerHTML = `<div class="empty"><div class="empty-ico">${EMPTY_SVG_PLUS}</div><div class="empty-title">No Devices Found</div><div class="empty-sub">Tap + to add your first smart device</div></div>`;
      return;
    }

    let list = filterDevices(devices);
    list = sortDevices(list);

    if (list.length === 0) {
      grid.innerHTML = `<div class="empty"><div class="empty-ico">${EMPTY_SVG_SRCH}</div><div class="empty-title">No Matches</div><div class="empty-sub">Try adjusting your search or filter</div></div>`;
      return;
    }

    // Build in a fragment â€” single reflow
    const frag = document.createDocumentFragment();
    const isLowEnd = document.body.classList.contains('low-end');

    list.forEach((device, i) => {
      const displayMsg = deviceOnlineStatus[device.device_id] || 'offline';
      const isOnline   = displayMsg !== 'offline' && displayMsg !== 'Checking...';
      const qcEnabled  = localStorage.getItem('quickControl') === 'true';

      const card = document.createElement('div');
      card.className = `device-card${isOnline ? ' online' : ''}`;
      card.dataset.deviceId = device.device_id;

      // Stagger animation delay (capped at 8 for perf; skip on low-end)
      if (!isLowEnd) {
        card.style.animationDelay = Math.min(i, 8) * 0.045 + 's';
      }

      const PLUG_ICON = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M12 16h.01"/></svg>`;
      const statusCls = displayMsg === 'Checking...' ? 'checking' : (isOnline ? 'online' : 'offline');

      if (qcEnabled && isOnline) {
        // â”€â”€ Swipeable card (exact logic from original) â”€â”€
        card.classList.add('swipeable');
        if (deviceSwipeState[device.device_id]) card.classList.add('swiped');

        const known    = devicePowerStatus[device.device_id] || null;
        const btnState = known === 'ON' ? 'state-on' : known === 'OFF' ? 'state-off' : 'state-unknown';
        const lblTxt   = known === 'ON' ? 'ON' : known === 'OFF' ? 'OFF' : 'â€”';
        const trackCls = deviceSwipeState[device.device_id] ? 'card-track revealed' : 'card-track';

        card.innerHTML = `
          <div class="${trackCls}">
            <div class="cp cp-info">
              <div class="device-icon">${PLUG_ICON}</div>
              <div class="device-name" style="width:100%">${device.device_id}</div>
              <div class="device-rank">Rank ${device.device_rank}</div>
              <div class="device-status online"><span class="status-dot-sm"></span><span>${displayMsg}</span></div>
              <div class="swipe-hint"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></div>
            </div>
            <div class="cp cp-ctrl" style="position:relative">
              <div class="qc-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
              <button class="qpbtn ${btnState}" data-device-id="${device.device_id}"
                onclick="event.stopPropagation();quickToggleDevice('${device.device_id}',this)">
                <svg class="qpico" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M12 2v10"/><path d="M18.4 6.6a9 9 0 1 1-12.77.04"/>
                </svg>
              </button>
              <span class="qplbl ${btnState}">${lblTxt}</span>
            </div>
          </div>`;

        attachSwipeListeners(card, device.device_id);
      } else {
        // â”€â”€ Normal card â”€â”€
        card.innerHTML = `
          <div class="device-icon">${PLUG_ICON}</div>
          <div class="device-info">
            <div class="device-name">${device.device_id}</div>
            <div class="device-rank">Rank ${device.device_rank}</div>
            <div class="device-status ${statusCls}"><span class="status-dot-sm"></span><span>${displayMsg}</span></div>
          </div>`;
        addHapticToElement(card, () => openDeviceControl(device.device_id));
      }

      frag.appendChild(card);
    });

    // Single DOM write
    grid.innerHTML = '';
    grid.appendChild(frag);
    updateStats();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // LIVE DEVICE STATUS UPDATE (no re-render)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateDeviceOnlineStatus(id, msg, isOnline) {
    document.querySelectorAll(`.device-card[data-device-id="${id}"]`).forEach(card => {
      card.classList.toggle('online', isOnline);
      const el = card.querySelector('.device-status');
      if (el) {
        const tx = el.querySelector('span:last-child');
        el.className = `device-status ${msg === 'Checking...' ? 'checking' : (isOnline ? 'online' : 'offline')}`;
        if (tx) tx.textContent = msg;
      }
      updateQcPanel(card, id, isOnline);
    });
    debouncedUpdateStats();
  }

  let _statsT = null;
  function debouncedUpdateStats() {
    clearTimeout(_statsT);
    _statsT = setTimeout(updateStats, 150);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CHECK STATUS â€” exact from original
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function checkAllDevicesStatus() {
    devices.forEach(d => {
      deviceOnlineStatus[d.device_id] = 'Checking...';
      updateDeviceOnlineStatus(d.device_id, 'Checking...', false);
      const ofTopic = `smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/OF`;
      clearTimeout(deviceTimeouts[d.device_id]);
      mqttClient.publish(ofTopic, 'check_status');
      deviceTimeouts[d.device_id] = setTimeout(() => {
        if (deviceOnlineStatus[d.device_id] === 'Checking...') {
          deviceOnlineStatus[d.device_id] = 'offline';
          updateDeviceOnlineStatus(d.device_id, 'offline', false);
        }
      }, 5000);
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NAVIGATION â€” exact from original
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openDeviceControl(id) {
    sessionStorage.setItem('active_device', id);
    sessionStorage.setItem('device_status_cache', JSON.stringify({
      status: deviceOnlineStatus[id] || 'unknown',
      isOnline: deviceOnlineStatus[id] !== 'offline' && deviceOnlineStatus[id] !== 'Checking...' && deviceOnlineStatus[id] !== 'unknown',
      timestamp: Date.now()
    }));
    window.location.href = 'control.html';
  }

  function addDevice() {
    hideActionSheet();
    const id = 'AADA-' + Math.random().toString(36).substr(2, 8).toUpperCase();
    sessionStorage.setItem('provisioning', JSON.stringify({
      email: currentUser.email, password: currentUser.password,
      hashed_email: currentUser.hashed_email, hashed_password: currentUser.hashed_password,
      device_id: id
    }));
    window.location.href = 'wifi_setup.html';
  }

  function refreshDevices() {
    hideActionSheet();
    if (!mqttClient || !mqttClient.connected) { alert('Not connected to server'); return; }
    checkAllDevicesStatus();
    const grid = document.getElementById('deviceGrid');
    grid.style.opacity = '0.55';
    grid.style.transform = 'scale(0.985)';
    setTimeout(() => { grid.style.opacity = '1'; grid.style.transform = ''; }, 380);
  }

  function logout() {
    hideActionSheet();
    if (confirm('Are you sure you want to logout?')) {
      localStorage.removeItem('remembered_user');
      localStorage.removeItem('rememberMe');
      sessionStorage.clear();
      window.location.href = 'login.html';
    }
  }

  function toggleRememberMe(enabled) {
    localStorage.setItem('rememberMe', enabled ? 'true' : 'false');
    if (enabled && currentUser) localStorage.setItem('remembered_user', JSON.stringify(currentUser));
    else localStorage.removeItem('remembered_user');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // QUICK CONTROL â€” exact from original
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleQuickControl(enabled) {
    localStorage.setItem('quickControl', enabled ? 'true' : 'false');
    if (enabled && mqttClient && mqttClient.connected) {
      devices.forEach(d => {
        mqttClient.subscribe(`smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${d.device_id}/status`);
      });
    }
    deviceSwipeState = {};
    renderDevices();
  }

  function attachSwipeListeners(card, id) {
    let sx=0, sy=0, st=0, drag=false, scroll=false;
    card.addEventListener('touchstart', e => {
      sx=e.touches[0].clientX; sy=e.touches[0].clientY;
      st=Date.now(); drag=true; scroll=false;
    }, {passive:true});
    card.addEventListener('touchmove', e => {
      if (!drag) return;
      const dx=e.touches[0].clientX-sx, dy=e.touches[0].clientY-sy;
      if (Math.abs(Math.atan2(dy,dx)*180/Math.PI-90) < 55) scroll=true;
    }, {passive:true});
    card.addEventListener('touchend', e => {
      if (!drag||scroll){drag=false;return;}
      drag=false;
      const dx=e.changedTouches[0].clientX-sx, dt=Date.now()-st;
      const isSwipe=Math.abs(dx)>36||(Math.abs(dx)>18&&dt<250);
      if (!isSwipe){
        const t=card.querySelector('.card-track');
        if (!t||!t.classList.contains('revealed')) openDeviceControl(id);
        return;
      }
      const t=card.querySelector('.card-track');
      if (!t) return;
      const rev=t.classList.contains('revealed');
      if (dx<0&&!rev)  { t.classList.add('revealed');    card.classList.add('swiped');    deviceSwipeState[id]=true; }
      else if (dx>0&&rev) { t.classList.remove('revealed'); card.classList.remove('swiped'); deviceSwipeState[id]=false; }
      else if (dx>0&&!rev) openDeviceControl(id);
    }, {passive:true});
  }

  function updateQcPanel(card, id, isOnline) {
    const btn = card.querySelector('.qpbtn');
    const lbl = card.querySelector('.qplbl');
    if (!btn||btn.classList.contains('state-pending')) return;
    const s = devicePowerStatus[id]||null;
    btn.className='qpbtn'; if(lbl) lbl.className='qplbl';
    if (!isOnline) {
      btn.classList.add('state-unknown'); btn.disabled=true;
      if(lbl){lbl.classList.add('state-unknown');lbl.textContent='Offline';}
    } else if (s==='ON') {
      btn.classList.add('state-on'); btn.disabled=false;
      if(lbl){lbl.classList.add('state-on');lbl.textContent='ON';}
    } else if (s==='OFF') {
      btn.classList.add('state-off'); btn.disabled=false;
      if(lbl){lbl.classList.add('state-off');lbl.textContent='OFF';}
    } else {
      btn.classList.add('state-unknown'); btn.disabled=false;
      if(lbl){lbl.classList.add('state-unknown');lbl.textContent='â€”';}
    }
  }

  function quickToggleDevice(id, btn) {
    if (!mqttClient||!mqttClient.connected){alert('Not connected');return;}
    if (btn.classList.contains('state-pending')) return;
    const online = deviceOnlineStatus[id]!=='offline'&&deviceOnlineStatus[id]!=='Checking...'&&deviceOnlineStatus[id]!=='unknown';
    if (!online) return;
    const cmd  = devicePowerStatus[id]==='ON'?'0':'1';
    const ctrl = `smartplug/${currentUser.hashed_email}/${currentUser.hashed_password}/${id}/control`;
    const lbl  = btn.closest('.cp-ctrl')?.querySelector('.qplbl');
    btn.className='qpbtn state-pending';
    if(lbl){lbl.className='qplbl state-pending';lbl.textContent='â€¦';}
    if (shouldHapticAll()||shouldHapticController()) hapticFeedback(getHapticIntensity());
    mqttClient.publish(ctrl, cmd);
    setTimeout(() => {
      if (btn.classList.contains('state-pending')) {
        const c=btn.closest('.device-card');
        if(c) updateQcPanel(c,id,online);
      }
    }, 5000);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // BOOT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.onload = init;
  window.addEventListener('pageshow', e => { if (e.persisted) init(); });
  </script>
</body>
</html>
